<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å° | U7's BlogğŸ‹</title><meta name="keywords" content="SpringBoot,Java,é¡¹ç›®,Redis,Mybatis-plus,Mybatis,Mysql"><meta name="author" content="U7's BlogğŸ‹"><meta name="copyright" content="U7's BlogğŸ‹"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="å­¦ä¹ é¡¹ç›®ä»0-1">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°">
<meta property="og:url" content="https://u7u7.top/posts/dp.html">
<meta property="og:site_name" content="U7&#39;s BlogğŸ‹">
<meta property="og:description" content="å­¦ä¹ é¡¹ç›®ä»0-1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-g7vgkd.webp">
<meta property="article:published_time" content="2025-07-28T03:00:25.000Z">
<meta property="article:modified_time" content="2025-08-03T12:24:07.508Z">
<meta property="article:author" content="U7&#39;s BlogğŸ‹">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="é¡¹ç›®">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Mybatis-plus">
<meta property="article:tag" content="Mybatis">
<meta property="article:tag" content="Mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-g7vgkd.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://u7u7.top/posts/dp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-03 20:24:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="U7's BlogğŸ‹" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/chengguo.jpg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">U7's BlogğŸ‹</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2025-07-28T03:00:25.000Z" title="å‘è¡¨äº 2025-07-28 11:00:25">2025-07-28</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-08-03T12:24:07.508Z" title="æ›´æ–°äº 2025-08-03 20:24:07">2025-08-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">3.6w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>134åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°">ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°</h1>
<p>ä¸»è¦æ˜¯ä½¿ç”¨redis+Springboot+mysql+mybatis-plusçš„é¡¹ç›®ã€‚ç›®çš„æ˜¯é”»ç‚¼redisçš„ä½¿ç”¨å’Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—æ–¹ä¾¿å­¦ä¹ mqã€‚æ¶ˆæ¯é˜Ÿåˆ—éƒ¨åˆ†redisä½¿ç”¨streamæ¥å®ç°ã€‚</p>
<h2 id="ç§’æ€æ€»ç»“-é‡ç‚¹"><strong>ç§’æ€æ€»ç»“(é‡ç‚¹):</strong></h2>
<p>é¡¹ç›®ä¸­ç§’æ€åœºæ™¯æ˜¯ä½¿ç”¨å¯ä»¥æŠ¢è´­æŸä¸ªä¼˜æƒ åŠµã€‚ç§’æ€ä¼šå‡ºç°çš„æƒ…å†µï¼Œä¸€ç§’ä¼šæœ‰åƒä¸‡çš„ç”¨æˆ·åŒæ—¶ç‚¹å‡»ï¼Œè®¿é—®æ¥å£ã€‚ä¼šå­˜åœ¨çš„é—®é¢˜å¹¶è§£å†³ï¼š</p>
<ol>
<li>ä¿è¯è®¢å• ID å…¨å±€å”¯ä¸€ï¼Œé¿å…è§„å¾‹æ€§æ³„éœ²ä¸šåŠ¡æ•°æ®ï¼›</li>
<li>é˜²æ­¢åº“å­˜è¶…å–ï¼Œç¡®ä¿å®é™…å–å‡ºæ•°é‡ä¸è¶…è¿‡åº“å­˜ï¼›</li>
<li>åº”å¯¹é«˜å¹¶å‘è¯·æ±‚ï¼Œé¿å…æ•°æ®åº“å‹åŠ›è¿‡å¤§å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚</li>
</ol>
<p><strong>æ³¨æ„ï¼ï¼å¹¶å‘é‡‡ç”¨jmteræ¨¡æ‹Ÿ</strong></p>
<h3 id="1ã€ä¿è¯è®¢å•IDå…¨å±€å”¯ä¸€"><strong>1ã€ä¿è¯è®¢å•IDå…¨å±€å”¯ä¸€</strong></h3>
<p>è‹¥ä½¿ç”¨æ•°æ®åº“è‡ªå¢ IDï¼Œå­˜åœ¨ä¸¤ä¸ªç¼ºé™·ï¼š</p>
<ol>
<li>ID è§„å¾‹æ€§æ˜æ˜¾ï¼Œæ˜“è¢«çŒœæµ‹æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ¯æ—¥è®¢å•é‡ï¼‰</li>
<li>å•è¡¨æ•°æ®é‡è¿‡å¤§æ—¶éœ€æ‹†åº“æ‹†è¡¨ï¼Œè‡ªå¢ ID æ— æ³•ä¿è¯å…¨å±€å”¯ä¸€ã€‚</li>
</ol>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåŸºäº Redis å®ç°å…¨å±€å”¯ä¸€ ID ç”Ÿæˆå™¨</p>
<ul>
<li>
<p>ID ç»„æˆ</p>
<ul>
<li>ç¬¦å·ä½ï¼ˆ1bitï¼Œå›ºå®šä¸º 0ï¼‰ï¼›</li>
<li>æ—¶é—´æˆ³ï¼ˆ31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯è¦†ç›– 69 å¹´ï¼‰ï¼›</li>
<li>åºåˆ—å·ï¼ˆ32bitï¼Œç§’å†…è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’ç”Ÿæˆ 2Â³Â² ä¸ªå”¯ä¸€ IDï¼‰ã€‚</li>
</ul>
</li>
<li>
<p>å®ç°é€»è¾‘</p>
<ul>
<li>
<p>ç”Ÿæˆå½“å‰æ—¶é—´æˆ³ï¼ˆç›¸å¯¹äºèµ·å§‹æ—¶é—´æˆ³çš„åç§»é‡ï¼‰ï¼›</p>
</li>
<li>
<p>æŒ‰æ—¥æœŸç”Ÿæˆ Redis è‡ªå¢åºåˆ—å·ï¼ˆç¡®ä¿æ¯æ—¥åºåˆ—å·ç‹¬ç«‹ï¼‰ï¼›</p>
</li>
<li>
<p>æ‹¼æ¥æ—¶é—´æˆ³å’Œåºåˆ—å·ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€‚</p>
</li>
</ul>
</li>
</ul>
<h3 id="2ã€è§£å†³è¶…å–é—®é¢˜">2ã€è§£å†³è¶…å–é—®é¢˜</h3>
<p>é—®é¢˜çš„äº§ç”Ÿï¼Œå¤§é‡è¯·æ±‚åŒæ—¶è®¿é—®æ•°æ®åº“ï¼Œåˆ¤æ–­å½“å‰å•†å“æœ‰åº“å­˜ï¼Œæ‰§è¡Œåº“å­˜æ‰£å‡çš„ä»£ç ï¼Œä¼šå¯¼è‡´è¶…å–ã€‚</p>
<p>è§£å†³çš„æ–¹å¼ï¼Œé€šè¿‡åç»­çš„æ›´æ–°ï¼Œå¯¹è¯¥æ–¹æ³•è¿›è¡Œäº†æ…¢æ…¢çš„ä¿®æ”¹ã€‚</p>
<h4 id="2-1-ä½¿ç”¨æ•°æ®åº“ä¹è§‚é”">2.1 ä½¿ç”¨æ•°æ®åº“ä¹è§‚é”</h4>
<p>åˆšå¼€å§‹é‡‡ç”¨ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶ï¼Œåœ¨æ•°æ®åº“å±‚é¢é€šè¿‡ç‰ˆæœ¬å·å’Œåº“å­˜åˆ¤æ–­æ¡ä»¶ç¡®ä¿æ‰£å‡åº“å­˜çš„åŸå­æ€§ï¼Œè§£å†³å¹¶å‘æ›´æ–°å¯¼è‡´è¶…å–ã€‚</p>
<details class="folding-tag" cyan close><summary> é€šè¿‡æ•°æ®åº“è§£å†³è¶…å–ä»£ç  </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seckillVoucherService.update().setSql(<span class="string">&quot;stock= stock -1&quot;</span>).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .update().gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>); <span class="comment">//where id = ? and stock &gt; 0</span></span><br></pre></td></tr></table></figure><p>åŸç†:</p><p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653369268550.png" alt="1653369268550"></p>
              </div>
            </details>
<h3 id="3ã€è§£å†³ä¸€äººä¸€å•é—®é¢˜">3ã€è§£å†³ä¸€äººä¸€å•é—®é¢˜</h3>
<p>TODO ä¸€äººä¸€å•å­˜åœ¨çš„é—®é¢˜ï¼ŒåŒæ ·æ˜¯å¹¶å‘åœºæ™¯ä¼šå‡ºç°é—®é¢˜</p>
<h4 id="3-1-åˆå§‹ç‰ˆæ•°æ®åº“åˆ¤æ–­">3.1 åˆå§‹ç‰ˆæ•°æ®åº“åˆ¤æ–­</h4>
<p>è¿™ä¸ªå¦‚æœä¸è€ƒè™‘é«˜å¹¶å‘çš„åœºæ™¯ï¼Œæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­è®¢å•è¡¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·idå°±å¥½ã€‚</p>
<details class="folding-tag" cyan close><summary> é€šè¿‡æ•°æ®åº“è§£å†³ä¸€äººä¸€å•é—®é¢˜ </summary>
              <div class='content'>
              <p><strong>è§£å†³</strong>ï¼šé‡ç‚¹å…¶å®åœ¨5çš„éƒ¨åˆ†ï¼Œç°åœ¨æ˜¯å…ˆé€šè¿‡æŸ¥è¯¢æ•°æ®åº“åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹è¿‡å•,å†å†³å®šæ˜¯å¦å¯ä»¥ä¸‹å•æ‰£é™¤åº“å­˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="comment">// 5.1.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>);;</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å­˜åœ¨é—®é¢˜</strong>:ç°åœ¨çš„é—®é¢˜è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶å‘è¿‡æ¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œéƒ½ä¸å­˜åœ¨è®¢å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œ</p>
              </div>
            </details>
<p><strong>è§£å†³</strong>ï¼šé¦–å…ˆæˆ‘ä»¬çš„åˆå§‹æ–¹æ¡ˆæ˜¯å°è£…äº†ä¸€ä¸ªcreateVoucherOrderæ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€synchronized é”ã€‚å†åœ¨åŸæ–¹æ³•ä¸­è°ƒç”¨createVoucherOrderæ–¹æ³•ã€‚</p>
<details class="folding-tag" cyan close><summary> é€šè¿‡æ‚²è§‚é”è§£å†³ </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å­˜åœ¨é—®é¢˜</strong>:è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶<strong>é”ç²’åº¦</strong> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦</p>
              </div>
            </details>
<p><strong>è§£å†³</strong>ï¼šè¿™æ®µä»£ç éœ€è¦ä¿®æ”¹ä¸ºï¼šintern() è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•</p>
<details class="folding-tag" cyan close><summary> è§£å†³é”ç²’åº¦å¤ªç²—çš„é—®é¢˜ </summary>
              <div class='content'>
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">            .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å­˜åœ¨é—®é¢˜</strong>:å½“å‰æ–¹æ³•è¢«springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ã€‚</p>
              </div>
            </details>
<p>è§£å†³ï¼šæˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<details class="folding-tag" cyan close><summary> è§£å†³äº‹åŠ¡é—®é¢˜ </summary>
              <div class='content'>
              <p>åœ¨seckillVoucher æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼Œè¿™æ ·å°±èƒ½ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿæ§åˆ¶äº†é”çš„ç²’åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (userId.toString().intern())&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.createVoucherOrder(voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯this.çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (userId.toString().intern())&#123;</span><br><span class="line">	<span class="type">ISeckillVoucherService</span> <span class="variable">proxy</span> <span class="operator">=</span> (ISeckillVoucherService) AopContext.currentProxy();</span><br><span class="line">	<span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>
<h4 id="3-2-åˆ†å¸ƒå¼é”è§£å†³é”å¤±æ•ˆ">3.2 åˆ†å¸ƒå¼é”è§£å†³é”å¤±æ•ˆ</h4>
<p><strong>æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ</strong></p>
<p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”<strong>äº’æ–¥</strong>çš„é”ã€‚</p>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653374296906.png" alt="1653374296906"></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨setnxæ–¹æ³•ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯</p>
<details class="folding-tag" cyan close><summary> åˆ†å¸ƒå¼é”åˆä½¿ç”¨ </summary>
              <div class='content'>
              <p>åˆ©ç”¨setnxæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶å¢åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œæ­¤æ–¹æ³•å¯ä»¥ä¿è¯åŠ é”å’Œå¢åŠ è¿‡æœŸæ—¶é—´å…·æœ‰åŸå­æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX=<span class="string">&quot;lock:&quot;</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId()</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é‡Šæ”¾é”é€»è¾‘</li></ul><p>SimpleRedisLock</p><p>é‡Šæ”¾é”ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡delåˆ é™¤é”</span></span><br><span class="line">    stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ä¸šåŠ¡ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">      <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">      <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">      <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">          <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">          <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">      <span class="comment">//åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç )</span></span><br><span class="line">      <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">      <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">      <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">          <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">          <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">          lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>
<p><strong>é—®é¢˜</strong>ï¼šä¼šå­˜åœ¨ä¸€ä¸ªé”è¯¯åˆ çš„æƒ…å†µï¼Œæ¯”å¦‚åŒæ—¶è¿›æ¥äº†çº¿ç¨‹ABCï¼Œæˆ‘ä»¬æ˜¯æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ã€‚å‡å¦‚çº¿ç¨‹Aä¸šåŠ¡é˜»å¡äº†ï¼Œæ‰§è¡Œæ—¶é—´è¶…è¿‡äº†è¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶é”è¿‡æœŸäº†è‡ªåŠ¨åˆ é™¤ã€‚çº¿ç¨‹Bæ‹¿åˆ°äº†é”ï¼Œå¹¶å¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œã€‚çº¿ç¨‹Aç»ˆäºæ‰§è¡Œå®Œäº†ï¼Œæ­¤æ—¶ä¸»åŠ¨åˆ é™¤äº†é”ã€‚é”åˆç©ºé—²äº†ï¼Œçº¿ç¨‹Cåˆæ‹¿åˆ°äº†é”ã€‚å¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼ŒBåˆæ‰§è¡Œå®Œäº†ï¼Œåˆ é™¤äº†é”ï¼Œè¿™æ ·æ˜¯é”è¯¯åˆ çš„æƒ…å†µã€‚</p>
<details class="folding-tag" cyan close><summary> çº¿ç¨‹æ ‡è¯†è§£å†³é”è¯¯åˆ  </summary>
              <div class='content'>
              <p>å¦‚æ ‡é¢˜ä¸€æ ·ï¼Œæˆ‘ä»¬ç»™çº¿ç¨‹é”çš„æ—¶å€™å¯ä»¥ç»™ä¸€ä¸ªçº¿ç¨‹æ ‡è¯†ï¼Œè¡¨ç¤ºè¿™ä¸ªé”ç»™äº†çº¿ç¨‹Bã€‚çº¿ç¨‹Aæ‰§è¡Œå®Œä¸šåŠ¡ï¼Œè¦åˆ é™¤é”çš„æ—¶å€™ï¼Œå‘ç°ä¸æ˜¯è‡ªå·±æ›¾ç»æ‹¿åˆ°çš„é”ï¼Œé‚£å°±ä¸åˆ é™¤ã€‚è¿™æ ·å°±è§£å†³äº†é”è¯¯åˆ ã€‚æˆ‘ä»¬é€šè¿‡UUIDç»™çº¿ç¨‹å¢åŠ æ ‡è¯†ã€‚</p>
              </div>
            </details>
<p><strong>é—®é¢˜</strong>ï¼šå­˜åœ¨ä¸€ä¸ªæç«¯çš„é”è¯¯åˆ é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä»£ç å¹¶æ²¡æœ‰ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿™ç§æƒ…å†µâ€”â€”å½“çº¿ç¨‹Aä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œåˆ¤æ–­é”æ˜¯å¦å±äºè‡ªå·±çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸ºtrueï¼Œå‡†å¤‡æ‰§è¡Œåˆ é™¤é”çš„æ“ä½œï¼Œåœ¨åˆ é™¤ä¹‹å‰ï¼Œé”è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œæ­¤æ—¶é”è¢«redisåˆ é™¤ï¼Œçº¿ç¨‹Bæ‹¿åˆ°äº†é”ï¼Œç„¶åAæ‰æ‰§è¡Œåˆ é™¤é”æ“ä½œï¼Œè¿™æ ·åˆæŠŠçº¿ç¨‹Bçš„é”ç»™åˆ äº†ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦å°†æ‹¿é”ï¼Œåˆ¤æ–­é”ï¼Œåˆ é™¤é”ä¿è¯åŸå­æ€§ã€‚</p>
<details class="folding-tag" cyan close><summary> Luaè„šæœ¬ä¿è¯åŸå­æ€§ </summary>
              <div class='content'>
              <p>è¿™ä¸ªæ—¶å€™é¡ºåˆ©å¼•å‡ºredisè‡ªå¸¦çš„luaè„šæœ¬ï¼Œé€šè¿‡callå‘½ä»¤ä¿è¯å¤šæ¡å‘½ä»¤çš„åŸå­æ€§ã€‚å®ƒä¹Ÿå¯ä»¥é€šè¿‡thenæ¥ä¿è¯ä¸Šä¸€æ¡å‘½ä»¤æ‰§è¡Œå®Œä»¥åè¿”å›çš„ç»“æœæ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œè¿™ä¸€å—ä¹Ÿä¿è¯äº†åŸå­æ€§ã€‚è¿™æ˜¯å®ƒçš„ä¼˜ç‚¹ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¨‹åºå‘˜åæœŸä¸å®Œå…¨ä½¿ç”¨redissionï¼Œè€Œä½¿ç”¨è°ƒç”¨luaè„šæœ¬çš„æ–¹å¼ä¿è¯åŸå­æ€§çš„åŸå› ã€‚åŒæ—¶å®ƒå¯ä»¥ä¼ é€’keyå’Œvalueçš„å‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤æ–­è¿”å›å€¼ï¼Œå®ç°æˆ‘ä»¬ä¸Šé¢åˆ¤æ–­çº¿ç¨‹æ ‡è¯†ã€‚</p><p>æ”¹é€ SimpleRedisLockæ‰§è¡Œluaè„šæœ¬</p><div class="tabs" id="javaæ‰§è¡Œluaè„šæœ¬"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#javaæ‰§è¡Œluaè„šæœ¬-1">Java</button></li><li class="tab"><button type="button" data-href="#javaæ‰§è¡Œluaè„šæœ¬-2">Luaè„šæœ¬</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="javaæ‰§è¡Œluaè„šæœ¬-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨luaè„šæœ¬</span></span><br><span class="line">    stringRedisTemplate.execute(</span><br><span class="line">            UNLOCK_SCRIPT,</span><br><span class="line">            Collections.singletonList(KEY_PREFIX + name),<span class="comment">//é”key</span></span><br><span class="line">            ID_PREFIX + Thread.currentThread().getId());<span class="comment">//çº¿ç¨‹æ ‡è¯†value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="javaæ‰§è¡Œluaè„šæœ¬-2"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><strong>æµ‹è¯•</strong>ï¼šç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼Œå¾—åˆ°äº†é”ï¼Œæ‰‹åŠ¨åˆ é™¤é”ï¼Œæ¨¡æ‹Ÿé”è¶…æ—¶äº†ï¼Œå…¶ä»–çº¿ç¨‹ä¼šæ‰§è¡Œluaæ¥æŠ¢é”ï¼Œå½“ç¬¬ä¸€å¤©çº¿ç¨‹åˆ©ç”¨luaåˆ é™¤é”æ—¶ï¼Œluaèƒ½ä¿è¯ä»–ä¸èƒ½åˆ é™¤ä»–çš„é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ é™¤é”æ—¶ï¼Œåˆ©ç”¨luaåŒæ ·å¯ä»¥ä¿è¯ä¸ä¼šåˆ é™¤åˆ«äººçš„é”ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯åŸå­æ€§ã€‚</p>
              </div>
            </details>
<h4 id="3-3-redissonè§£å†³å››å¤§é—®é¢˜">3.3 redissonè§£å†³å››å¤§é—®é¢˜</h4>
<p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<p><strong>é‡å…¥é—®é¢˜</strong>ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</p>
<p><strong>ä¸å¯é‡è¯•</strong>ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</p>
<p><strong>è¶…æ—¶é‡Šæ”¾</strong>ï¼šæˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</p>
<p><strong>ä¸»ä»ä¸€è‡´æ€§ï¼š</strong> å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653546070602-17538468019109.png" alt="1653546070602"></p>
<p>Redissonå¯¹ä»£ç çš„æ”¹é€ ï¼Œè¿™é‡Œæˆ‘è¦è¯´ä¸€ä¸‹ï¼Œredissoné…ç½®å¥½redisä»¥åï¼Œå®ƒæ˜¯è‡ªå¸¦è·å–é”å’Œé‡Šæ”¾é”çš„æ–¹æ³•çš„ã€‚å®ƒåº•å±‚ä¿è¯äº†åŸå­æ€§å’Œè§£å†³äº†ä¸Šé¢çš„éƒ¨åˆ†é—®é¢˜ï¼Œè¯¦ç»†åœ¨ä¸‹é¢åˆ†å¸ƒå¼é”-redissionä¸­æœ‰ï¼Œæ¯”è¾ƒæŠ½è±¡ï¼Œä½†æ˜¯åº•å±‚å…¶å®è¿˜æ˜¯ä½¿ç”¨äº†luaè„šæœ¬ã€‚çœ‹å®Œæºç è°ˆè°ˆè‡ªå·±çš„ç†è§£çš„å¯é‡å…¥æœºåˆ¶ã€‚çœ‹é—¨ç‹—å’Œä¸»ä»å°±ä¸ç»†è¯´äº†ã€‚</p>
<blockquote>
<p>è¯´ç™½äº†ï¼Œå…ˆåˆ¤æ–­é”å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±ï¼Œè¯´æ˜æ˜¯é¦–æ¬¡æ“ä½œåˆ›å»ºé”ï¼Œè‹¥ä¸»é”å­˜åœ¨ï¼Œä¸”å“ˆå¸Œè¡¨ä¸­å­˜åœ¨å½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆ<code>ARGV[2]</code>ï¼‰ï¼Œè¯´æ˜æ˜¯<strong>åŒä¸€çº¿ç¨‹å†æ¬¡è¯·æ±‚é”</strong>ï¼ˆå¯é‡å…¥åœºæ™¯ï¼‰å°†é‡å…¥æ¬¡æ•°+1ï¼Œå†è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚è¿”å›nilè¡¨ç¤ºé‡å…¥é”æˆåŠŸã€‚é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰çš„æ—¶å€™ return redis.call(â€˜pttlâ€™, KEYS[1]);</p>
</blockquote>
<div class="tabs" id="redisson"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-1">Redissonå®¢æˆ·ç«¯é…ç½®</button></li><li class="tab"><button type="button" data-href="#redisson-2">ä»£ç æ”¹é€ </button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-2"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Long userId = UserHolder.getUser().getId();</span><br><span class="line">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span><br><span class="line">//SimpleRedisLock lock = new SimpleRedisLock(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">RLock lock = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">//è·å–é”å¯¹è±¡</span><br><span class="line">boolean isLock = lock.tryLock();</span><br><span class="line">//åŠ é”å¤±è´¥</span><br><span class="line"><span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">try &#123;</span><br><span class="line">    //è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span><br><span class="line">    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    //é‡Šæ”¾é”</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="4ã€å¼‚æ­¥ç§’æ€">4ã€å¼‚æ­¥ç§’æ€</h3>
<p>è¿™é‡Œçš„ä¼˜åŒ–æ€è·¯æ˜¯çœ‹Tomcatéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸ºäº†ä¿è¯åŸå­æ€§ä¼šç‰ºç‰²æ•ˆç‡ï¼Œç°åœ¨æˆ‘ä»¬çš„ç¨‹åºç±»ä¼¼äºä¸²è¡ŒåŒ–ã€‚éœ€è¦å…ˆæŸ¥åˆ¸åœ¨åˆ¤æ–­åº“å­˜ï¼Œå†æŸ¥è®¢å•çœ‹æ˜¯ä¸æ˜¯ä¸€äººä¸€å•ï¼Œå†å‡å°‘åº“å­˜å†å­˜è®¢å•ã€‚æˆ‘ä»¬å¯ä»¥å°†åˆ¤æ–­åº“å­˜å’Œç”¨æˆ·æ˜¯å¦ä¸‹è¿‡å•æ”¾åœ¨redisä¸­åˆ¤æ–­ï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ä½¿ç”¨luaè„šæœ¬ï¼Œé€šè¿‡è¿”å›å€¼åˆ¤æ–­æ˜¯å¦èƒ½ä¸‹å•ï¼Œæˆ‘ä»¬å¯ä»¥å°†èƒ½ä¸‹å•çš„ä»»åŠ¡ï¼Œä¸¢åˆ°ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¯¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚å®ç°å¼‚æ­¥ä¸‹å•ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653562234886.png" alt="1653562234886"></p>
<ul>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
</ul>
<p>å®ç°æ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>é¦–å…ˆåœ¨ä¿å­˜ç§’æ€åˆ¸çš„æ—¶å€™ï¼Œå°†åº“å­˜ä¿¡æ¯å­˜ä¸€ä»½åˆ°redisï¼›seckill:stock:è®¢å•ID ä¸ºkey  åº“å­˜é‡ä¸ºvalue</li>
<li>ç¼–å†™luaè„šæœ¬ï¼Œå‚æ•°éœ€è¦3ä¸ªvalueï¼Œ<strong>ä¼˜æƒ åˆ¸ID ç”¨æˆ·IDå’Œè®¢å•ID</strong>,è„šæœ¬ä¸šåŠ¡åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œç”¨æˆ·æ˜¯å¦ä¸‹å•ï¼Œä¸æ»¡è¶³å°±è¿”å›1æˆ–è€…2ã€‚è¿”å›0ä»£è¡¨èƒ½é¡ºåˆ©ä¸‹å•ï¼Œæ­¤æ—¶æ‰£é™¤redisä¼˜æƒ åˆ¸åº“å­˜-1ï¼Œä¿å­˜ç”¨æˆ·IDåˆ°redis(setç±»å‹) seckill:order:è®¢å•ID ç”¨æˆ·ä¸ºkey valueä¸ºIDã€‚</li>
<li>æ‰§è¡Œé€»è¾‘: JAVAä»£ç éœ€è¦åˆ›å»ºçº¿ç¨‹æ± newSingleThreadExecutorå’Œé˜»å¡é˜Ÿåˆ—BlockingQueueã€‚è¿™é‡Œéƒ½æ˜¯ç”¨çš„åŸºç¡€çš„ï¼Œä¸ç”¨é…ç½®å‚æ•°ã€‚ç±»åˆå§‹åŒ–åçº¿ç¨‹æ± ä¼šåˆ†é…ç©ºé—²çº¿ç¨‹æ‰§è¡Œnew VoucherOrderHandler()ã€‚è¿™æ˜¯ä¸€ä¸ªä»»åŠ¡ç±»ï¼Œå°±æ˜¯å¯ä»¥è¢«çº¿ç¨‹æ‰§è¡Œçš„ä¸€æ®µä»£ç ã€‚çº¿ç¨‹ä¼šä¸€ç›´ä¸æ–­çš„æ‰§è¡Œä»–çš„runæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä»£ç ä¸­while(True)ä»é˜Ÿåˆ—ä¸­è·å–è®¢å•ä¿¡æ¯ï¼Œè¿™é‡Œä½¿ç”¨äº†takeæ–¹æ³•ã€‚**BlockingQueueçš„take()æ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡å¼è·å–å…ƒç´ çš„æ–¹æ³• å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œè°ƒç”¨take()çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰ï¼Œè¿›å…¥WAITINGçŠ¶æ€ï¼Œä¸ä¼šå ç”¨ CPU èµ„æºï¼›ç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹å‘é˜Ÿåˆ—ä¸­æ·»åŠ äº†å…ƒç´ ï¼ˆå³æ–°ä»»åŠ¡å…¥é˜Ÿï¼‰ï¼Œé˜»å¡çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œtake()å¹¶è¿”å›æ–°å…ƒç´ ã€‚**å½“ç”¨æˆ·ç‚¹å‡»æŠ¢è´­ç§’æ€å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œæ‰§è¡ŒseckillVoucheræ–¹æ³•ï¼Œå…ˆæ‰§è¡Œluaè„šæœ¬ï¼Œåˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0ï¼Œç»“æœä¸ä¸º0ç›´æ¥è¿”å›æ— åº“å­˜æˆ–è€…ä¸‹è¿‡å•äº†ã€‚å¦‚æœä¸º0å°†åˆ›å»ºvoucherOrderå¯¹è±¡å¹¶æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­å»ï¼ŒåŒæ—¶è·å–ä»£ç†å¯¹è±¡(åé¢ä»£ç ä¿è¯äº‹åŠ¡çš„)ã€‚å½“æ‹¿åˆ°è®¢å•ä¿¡æ¯ä»¥åï¼Œä¼šæ‰§è¡Œåˆ›å»ºè®¢å•handleVoucherOrder(voucherOrder);åˆ›å»ºè®¢å•çš„æ—¶å€™åŠ é”ä¿è¯äº†ä¸€äººä¸€å•ï¼Œå› ä¸ºé˜²æ­¢äº‹åŠ¡å¤±æ•ˆï¼ˆå› ä¸ºspringäº‹åŠ¡æ˜¯åœ¨threadlocalçº¿ç¨‹å‰¯æœ¬å˜é‡ä¸­ï¼Œå…¶ä»–çº¿ç¨‹æ‹¿ä¸åˆ°ï¼Œè¿™é‡Œæ˜¯å¤šçº¿ç¨‹ä¼šäº‹åŠ¡å¤±æ•ˆï¼‰ï¼Œæ‰€ä»¥å°†æ¥å£å®šä¹‰åœ¨æœ€å¤–é¢å¯ä»¥è°ƒç”¨åˆ›å»ºè®¢å•æ–¹æ³•ä¿è¯äº‹åŠ¡æ€§ã€‚æ­¤æ—¶åˆ›å»ºè®¢å•ä»»åŠ¡æ‰§è¡Œæ•°æ®åº“æ‰£å‡åº“å­˜å’Œä¿å­˜è®¢å•IDçš„æ“ä½œã€‚</li>
</ol>
</blockquote>
<p>ä»£ç å¦‚ä¸‹:</p>
<div class="tabs" id="é˜»å¡é˜Ÿåˆ—ç§’æ€"><ul class="nav-tabs"><li class="tab"><button type="button" data-href="#é˜»å¡é˜Ÿåˆ—ç§’æ€-1">Luaè„šæœ¬</button></li><li class="tab"><button type="button" data-href="#é˜»å¡é˜Ÿåˆ—ç§’æ€-2">æ”¾é˜»å¡é˜Ÿåˆ—</button></li><li class="tab active"><button type="button" data-href="#é˜»å¡é˜Ÿåˆ—ç§’æ€-3">çº¿ç¨‹æ± åˆ†é…ä»»åŠ¡</button></li><li class="tab"><button type="button" data-href="#é˜»å¡é˜Ÿåˆ—ç§’æ€-4">æ›´æ–°æ•°æ®åº“</button></li></ul><div class="tab-contents"><div class="tab-item-content" id="é˜»å¡é˜Ÿåˆ—ç§’æ€-1"><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"><span class="comment">-- æ•°æ®key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&quot;get&quot;</span>,stockKey) ~= <span class="literal">nil</span> <span class="keyword">and</span> <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>,stockKey))  &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&quot;sismember&quot;</span>,orderKey,userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- ç”¨æˆ·å·²è´­ä¹°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜ userIdå­˜seté›†åˆè¿”å›0</span></span><br><span class="line">redis.call(<span class="string">&quot;incrby&quot;</span>,stockKey,<span class="number">-1</span>)</span><br><span class="line">redis.call(<span class="string">&quot;sadd&quot;</span>,orderKey,userId)</span><br><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ... æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨</span></span><br><span class="line"><span class="comment">--redis.call(&#x27;xadd&#x27;, &#x27;stream.orders&#x27;, &#x27;*&#x27;, &#x27;userId&#x27;, userId, &#x27;voucherId&#x27;, voucherId, &#x27;id&#x27;, orderId)</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="é˜»å¡é˜Ÿåˆ—ç§’æ€-2"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è°ƒç”¨æ¥å£çš„æ—¶å€™å°±æ‰§è¡Œå°†ä»»åŠ¡ä¸¢é˜»å¡é˜Ÿåˆ—å¹¶è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">        SECKILL_SCRIPT,</span><br><span class="line">        Collections.emptyList(),</span><br><span class="line">        voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 2.4.ç”¨æˆ·id</span></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 2.5.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    <span class="comment">// 2.6.æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    <span class="comment">//3.è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService)AopContext.currentProxy();</span><br><span class="line">    <span class="comment">//4.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content active" id="é˜»å¡é˜Ÿåˆ—ç§’æ€-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">//åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks =<span class="keyword">new</span>  <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"><span class="comment">//åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä¹‹åï¼Œéšæ—¶éƒ½æ˜¯æœ‰å¯èƒ½è¦æ‰§è¡Œçš„</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">   SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨äºçº¿ç¨‹æ± å¤„ç†çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// å½“åˆå§‹åŒ–å®Œæ¯•åï¼Œå°±ä¼šå»ä»å¯¹åˆ—ä¸­å»æ‹¿ä¿¡æ¯</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">// 2.åˆ›å»ºè®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">          	 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">            <span class="comment">//1.è·å–ç”¨æˆ·</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">            <span class="comment">// 2.åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">            <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">            <span class="comment">// 3.å°è¯•è·å–é”</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.lock();</span><br><span class="line">            <span class="comment">// 4.åˆ¤æ–­æ˜¯å¦è·å¾—é”æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">                <span class="comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span><br><span class="line">                log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">//æ³¨æ„ï¼šç”±äºæ˜¯springçš„äº‹åŠ¡æ˜¯æ”¾åœ¨threadLocalä¸­ï¼Œæ­¤æ—¶çš„æ˜¯å¤šçº¿ç¨‹ï¼Œäº‹åŠ¡ä¼šå¤±æ•ˆ</span></span><br><span class="line">                proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                redisLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="é˜»å¡é˜Ÿåˆ—ç§’æ€-4"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">        .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">        .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="5ã€æ¶ˆæ¯é˜Ÿåˆ—">5ã€æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>æ¶ˆæ¯é˜Ÿåˆ—å…¶å®å°±æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯ä»¥æŠŠä¸€äº›ä»»åŠ¡ä¸¢åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä»–çš„å¥½å¤„<strong>è§£è€¦</strong>ï¼Œæ¯”å¦‚ç”Ÿäº§è€…å‘å®ŒæŒ‚äº†ï¼Œæ¶ˆè´¹è€…æœªæ¶ˆè´¹ï¼Œåæ­£åªè¦æ•°æ®å­˜åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ•°æ®å°±ç›¸å½“äºä¸€ä»½å¤‡ä»½ï¼Œèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚æˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨rediså»è¿›è¡Œæ ¡éªŒä¸‹å•æ¡ä»¶ï¼Œå†é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653574849336.png" alt="1653574849336"></p>
<p>å› ä¸ºä¸€èˆ¬æ¶ˆæ¯é˜Ÿåˆ—MQ,ä¼šæœ‰å…¶ä»–çš„ä¸­é—´ä»¶ä½¿ç”¨ï¼Œè¿™é‡Œå­¦ä¹ rediså¯ä»¥ä½¿ç”¨redisæ”¯æŒçš„mqï¼Œå®é™…ä¸šåŠ¡ä¸­ä¸ç»å¸¸ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸åšé‡ç‚¹è¦æ±‚ï¼Œçœ‹ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—çš„å¯¹æ¯”ï¼Œæˆ‘ä»¬é€‰æ‹©streamæ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ä»£ç æ”¹é€ ï¼ŒStreamè¿˜æ”¯æŒæ¶ˆè´¹ç»„ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653578560691.png" alt="1653578560691"></p>
<p>é€šè¿‡Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€ä¸‹å•ï¼Œä»£ç è¿›è¡Œæ”¹é€ ã€‚è¿™é‡Œé€»è¾‘ä¸è®²äº†ä¸æ˜¯å¾ˆé‡è¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6ã€jmeteræµ‹è¯•é«˜å¹¶å‘ï¼Œæ·»åŠ token">6ã€jmeteræµ‹è¯•é«˜å¹¶å‘ï¼Œæ·»åŠ token</h3>
<p>è¿™ä¸€å—æ˜¯åœ¨ä»å¼‚æ­¥ç§’æ€ä¸‹å•é‚£è¾¹æµ‹è¯•å¤šä¸ªç”¨æˆ·åŒæ—¶ä¸‹å•çš„æ—¶å€™ï¼Œå‡ºç°çš„é—®é¢˜ï¼Œå› ä¸ºä¹‹å‰æ²¡ä½¿ç”¨è¿‡jmeterã€‚è€å¸ˆé‚£è¾¹ç›´æ¥å‘é€äº†1000æ¡è¯·æ±‚ï¼Œä½†æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦æœ‰å¯¹åº”çš„tokenï¼Œè€å¸ˆæä¾›çš„æ•°æ®åº“ä¸­ç”¨æˆ·å·²ç»æ–°å»ºå¥½äº†ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å‘redisæ·»åŠ tokenï¼Œå¹¶ä¸”è¦æŠŠtokenä¿å­˜åˆ°ä¸€ä¸ªtxtæ–‡ä»¶ï¼Œæ–¹ä¾¿jmeteræŒ‰è¡Œè°ƒç”¨ã€‚è¿™é‡Œæˆ‘å†™äº†ä¸€ä¸ªæµ‹è¯•ç±»ã€‚æ‰§è¡Œå®Œä¼šå†resourceä¸‹é¢ç”Ÿæˆä¸€ä¸ªtokens.txtã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">tokenTest</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//ä»æ•°æ®åº“ç”¨æˆ·è¡¨æ‹¿å…¨éƒ¨user</span></span><br><span class="line">        List&lt;User&gt; userList = userService.list();</span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            <span class="comment">//å°†tokenå†™å…¥æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;tokens.txt&quot;</span>, <span class="literal">false</span>); <span class="comment">// å…ˆæ¸…ç©ºåŸæ–‡ä»¶</span></span><br><span class="line">                writer.write(token + System.lineSeparator());</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;é”™è¯¯ä¿¡æ¯&#123;&#125;&quot;</span>, String.valueOf(e));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">tokenKey</span> <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br><span class="line">            <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">            Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">                    CopyOptions.create()</span><br><span class="line">                            .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                            .setFieldValueEditor((fieldName,fieldValue)-&gt;fieldValue.toString()));</span><br><span class="line">            stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>jmeteré…ç½®ï¼ŒHTTPä¿¡æ¯å¤´ç®¡ç†å™¨ä¸­é…ç½®authorization ${token}ã€‚å¯¹äº†è®°å¾—åŠ æ–­è¨€ï¼Œå°†successæ–­è¨€è®¾ç½®trueã€‚ä¸ç„¶ä¼šéƒ½æ˜¯è¿”å›æˆåŠŸæ— æ³•åˆ¤æ–­æŠ¥å‘Šçš„å¼‚å¸¸äº†ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/image-20250730155921675.png" alt="image-20250730155921675"></p>
<h2 id="1ã€çŸ­ä¿¡ç™»å½•">1ã€çŸ­ä¿¡ç™»å½•</h2>
<h3 id="1-1ã€å¯¼å…¥ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°é¡¹ç›®">1.1ã€å¯¼å…¥ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°é¡¹ç›®</h3>
<h4 id="1-1-1-ã€å¯¼å…¥SQL">1.1.1 ã€å¯¼å…¥SQL</h4>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653057872536.png" alt="1653057872536"></p>
<h4 id="1-1-2ã€æœ‰å…³å½“å‰æ¨¡å‹">1.1.2ã€æœ‰å…³å½“å‰æ¨¡å‹</h4>
<p>æ‰‹æœºæˆ–è€…appç«¯å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æˆ‘ä»¬çš„nginxæœåŠ¡å™¨ï¼ŒnginxåŸºäºä¸ƒå±‚æ¨¡å‹èµ°çš„äº‹HTTPåè®®ï¼Œå¯ä»¥å®ç°åŸºäºLuaç›´æ¥ç»•å¼€tomcatè®¿é—®redisï¼Œä¹Ÿå¯ä»¥ä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ï¼Œè½»æ¾æ‰›ä¸‹ä¸Šä¸‡å¹¶å‘ï¼Œ è´Ÿè½½å‡è¡¡åˆ°ä¸‹æ¸¸tomcatæœåŠ¡å™¨ï¼Œæ‰“æ•£æµé‡ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€å°4æ ¸8Gçš„tomcatï¼Œåœ¨ä¼˜åŒ–å’Œå¤„ç†ç®€å•ä¸šåŠ¡çš„åŠ æŒä¸‹ï¼Œå¤§ä¸äº†å°±å¤„ç†1000å·¦å³çš„å¹¶å‘ï¼Œ ç»è¿‡nginxçš„è´Ÿè½½å‡è¡¡åˆ†æµåï¼Œåˆ©ç”¨é›†ç¾¤æ”¯æ’‘èµ·æ•´ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶nginxåœ¨éƒ¨ç½²äº†å‰ç«¯é¡¹ç›®åï¼Œæ›´æ˜¯å¯ä»¥åšåˆ°åŠ¨é™åˆ†ç¦»ï¼Œè¿›ä¸€æ­¥é™ä½tomcatæœåŠ¡çš„å‹åŠ›ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¾—é nginxèµ·ä½œç”¨ï¼Œæ‰€ä»¥nginxæ˜¯æ•´ä¸ªé¡¹ç›®ä¸­é‡è¦çš„ä¸€ç¯ã€‚</p>
<p>åœ¨tomcatæ”¯æ’‘èµ·å¹¶å‘æµé‡åï¼Œæˆ‘ä»¬å¦‚æœè®©tomcatç›´æ¥å»è®¿é—®Mysqlï¼Œæ ¹æ®ç»éªŒMysqlä¼ä¸šçº§æœåŠ¡å™¨åªè¦ä¸Šç‚¹å¹¶å‘ï¼Œä¸€èˆ¬æ˜¯16æˆ–32 æ ¸å¿ƒcpuï¼Œ32 æˆ–64Gå†…å­˜ï¼Œåƒä¼ä¸šçº§mysqlåŠ ä¸Šå›ºæ€ç¡¬ç›˜èƒ½å¤Ÿæ”¯æ’‘çš„å¹¶å‘ï¼Œå¤§æ¦‚å°±æ˜¯4000èµ·~7000å·¦å³ï¼Œä¸Šä¸‡å¹¶å‘ï¼Œ ç¬é—´å°±ä¼šè®©MysqlæœåŠ¡å™¨çš„cpuï¼Œç¡¬ç›˜å…¨éƒ¨æ‰“æ»¡ï¼Œå®¹æ˜“å´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šé€‰æ‹©ä½¿ç”¨mysqlé›†ç¾¤ï¼ŒåŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥é™ä½Mysqlçš„å‹åŠ›ï¼ŒåŒæ—¶å¢åŠ è®¿é—®çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåŠ å…¥Redisï¼ŒåŒæ—¶ä½¿ç”¨Redisé›†ç¾¤ä½¿å¾—Rediså¯¹å¤–æä¾›æ›´å¥½çš„æœåŠ¡ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653059409865.png" alt="1653059409865"></p>
<h4 id="1-1-3ã€å¯¼å…¥åç«¯é¡¹ç›®">1.1.3ã€å¯¼å…¥åç«¯é¡¹ç›®</h4>
<p>åœ¨èµ„æ–™ä¸­æä¾›äº†ä¸€ä¸ªé¡¹ç›®æºç ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653060237073.png" alt="1653060237073"></p>
<h4 id="1-1-4ã€å¯¼å…¥å‰ç«¯å·¥ç¨‹">1.1.4ã€å¯¼å…¥å‰ç«¯å·¥ç¨‹</h4>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653060337562.png" alt="1653060337562"></p>
<h3 id="1-2ã€redisè®¾è®¡">1.2ã€redisè®¾è®¡</h3>
<p>é¦–å…ˆæˆ‘ä»¬è¦æ€è€ƒä¸€ä¸‹åˆ©ç”¨redisæ¥å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆåˆ°åº•ä½¿ç”¨å“ªç§ç»“æ„å‘¢ï¼Ÿç”±äºå­˜å…¥çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨Stringï¼Œæˆ–è€…æ˜¯ä½¿ç”¨å“ˆå¸Œï¼Œå¦‚ä¸‹å›¾ï¼Œå¦‚æœä½¿ç”¨Stringï¼Œæ³¨æ„ä»–çš„valueï¼Œç”¨å¤šå ç”¨ä¸€ç‚¹ç©ºé—´ï¼Œå¦‚æœä½¿ç”¨å“ˆå¸Œï¼Œåˆ™ä»–çš„valueä¸­åªä¼šå­˜å‚¨ä»–æ•°æ®æœ¬èº«ï¼Œå¦‚æœä¸æ˜¯ç‰¹åˆ«åœ¨æ„å†…å­˜ï¼Œå…¶å®ä½¿ç”¨Stringå°±å¯ä»¥å•¦ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653319261433.png" alt="1653319261433"></p>
<h4 id="1-2-1ã€è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚">1.2.1ã€è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚</h4>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Stringç»“æ„ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„keyï¼Œvalueé”®å€¼å¯¹çš„æ–¹å¼ï¼Œä½†æ˜¯å…³äºkeyçš„å¤„ç†ï¼Œsessionä»–æ˜¯æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„sessionï¼Œä½†æ˜¯redisçš„keyæ˜¯å…±äº«çš„ï¼Œå’±ä»¬å°±ä¸èƒ½ä½¿ç”¨codeäº†</p>
<p>åœ¨è®¾è®¡è¿™ä¸ªkeyçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹‹å‰è®²è¿‡éœ€è¦æ»¡è¶³ä¸¤ç‚¹</p>
<p>1ã€keyè¦å…·æœ‰å”¯ä¸€æ€§</p>
<p>2ã€keyè¦æ–¹ä¾¿æºå¸¦</p>
<p>å¦‚æœæˆ‘ä»¬é‡‡ç”¨phoneï¼šæ‰‹æœºå·è¿™ä¸ªçš„æ•°æ®æ¥å­˜å‚¨å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœæŠŠè¿™æ ·çš„æ•æ„Ÿæ•°æ®å­˜å‚¨åˆ°redisä¸­å¹¶ä¸”ä»é¡µé¢ä¸­å¸¦è¿‡æ¥æ¯•ç«Ÿä¸å¤ªåˆé€‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åå°ç”Ÿæˆä¸€ä¸ªéšæœºä¸²tokenï¼Œç„¶åè®©å‰ç«¯å¸¦æ¥è¿™ä¸ªtokenå°±èƒ½å®Œæˆæˆ‘ä»¬çš„æ•´ä½“é€»è¾‘äº†</p>
<h4 id="1-2-2ã€æ•´ä½“è®¿é—®æµç¨‹">1.2.2ã€æ•´ä½“è®¿é—®æµç¨‹</h4>
<p>å½“æ³¨å†Œå®Œæˆåï¼Œç”¨æˆ·å»ç™»å½•ä¼šå»æ ¡éªŒç”¨æˆ·æäº¤çš„æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºï¼Œæœ€åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°redisï¼Œå¹¶ä¸”ç”Ÿæˆtokenä½œä¸ºredisçš„keyï¼Œå½“æˆ‘ä»¬æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æ—¶ï¼Œä¼šå»æºå¸¦ç€tokenè¿›è¡Œè®¿é—®ï¼Œä»redisä¸­å–å‡ºtokenå¯¹åº”çš„valueï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹¦æˆªï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653319474181.png" alt="1653319474181"></p>
<h3 id="1-3ã€ä½¿ç”¨rediså®ŒæˆçŸ­ä¿¡ç™»å½•">1.3ã€ä½¿ç”¨rediså®ŒæˆçŸ­ä¿¡ç™»å½•</h3>
<p><strong>UserControllerä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€æ‰‹æœºéªŒè¯ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;code&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone)</span> &#123;</span><br><span class="line">    <span class="comment">//å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span></span><br><span class="line">    <span class="keyword">return</span> userService.sendCode(phone);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç™»å½•åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loginForm ç™»å½•å‚æ•°ï¼ŒåŒ…å«æ‰‹æœºå·ã€éªŒè¯ç ï¼›æˆ–è€…æ‰‹æœºå·ã€å¯†ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginFormDTO loginForm)</span>&#123;</span><br><span class="line">    <span class="comment">//å®ç°ç™»å½•åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">return</span> userService.login(loginForm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserServiceImplä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–éªŒè¯ç code</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//å­˜å…¥redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.LOGIN_CODE_KEY + phone, code, RedisConstants.LOGIN_CODE_TTL, TimeUnit.MINUTES);</span><br><span class="line">    log.debug(<span class="string">&quot;å‘é€éªŒè¯ç  phone=&#123;&#125;,code = &#123;&#125;&quot;</span>,phone, code);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">    <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç™»å½• è¦å…ˆå°†éªŒè¯ç å–å‡ºæ¥</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(RedisConstants.LOGIN_CODE_KEY + phone);</span><br><span class="line">    <span class="keyword">if</span> (cacheCode == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æœªæ³¨å†Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">    <span class="comment">//æŸ¥çœ‹æ‰‹æœºå·å’ŒéªŒè¯ç æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> (!cacheCode.equals(code)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();</span><br><span class="line">    <span class="comment">// 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜</span></span><br><span class="line">        user = createUserWithPhone(phone);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° redisä¸­</span></span><br><span class="line">    <span class="comment">// 7.1.éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="comment">// 7.2.å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">    Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO,<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">            CopyOptions.create()</span><br><span class="line">                    .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                    .setFieldValueEditor((fieldName,fieldValue)-&gt;fieldValue.toString()));</span><br><span class="line">    stringRedisTemplate.opsForHash().putAll(RedisConstants.LOGIN_USER_KEY + token, userMap);</span><br><span class="line">    <span class="comment">// 7.3.è®¾ç½®tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.expire(RedisConstants.LOGIN_USER_KEY + token, RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜">1.4 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</h3>
<h4 id="1-4-1-åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š">1.4.1 åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š</h4>
<p>åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œä»–ç¡®å®å¯ä»¥ä½¿ç”¨å¯¹åº”è·¯å¾„çš„æ‹¦æˆªï¼ŒåŒæ—¶åˆ·æ–°ç™»å½•tokenä»¤ç‰Œçš„å­˜æ´»æ—¶é—´ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä»–åªæ˜¯æ‹¦æˆªéœ€è¦è¢«æ‹¦æˆªçš„è·¯å¾„ï¼Œå‡è®¾å½“å‰ç”¨æˆ·è®¿é—®äº†ä¸€äº›ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ­¤æ—¶ä»¤ç‰Œåˆ·æ–°çš„åŠ¨ä½œå®é™…ä¸Šå°±ä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä»–æ˜¯å­˜åœ¨é—®é¢˜çš„</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653320822964.png" alt="1653320822964"></p>
<h4 id="1-4-2-ä¼˜åŒ–æ–¹æ¡ˆ">1.4.2 ä¼˜åŒ–æ–¹æ¡ˆ</h4>
<p>æ—¢ç„¶ä¹‹å‰çš„æ‹¦æˆªå™¨æ— æ³•å¯¹ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶åˆ·æ–°ä»¤ç‰Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†threadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653320764547.png" alt="1653320764547"></p>
<h4 id="1-4-3-ä»£ç ">1.4.3 ä»£ç </h4>
<p><strong>RefreshTokenInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.åŸºäºTOKENè·å–redisä¸­çš„ç”¨æˆ·</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span>  <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5.å°†æŸ¥è¯¢åˆ°çš„hashæ•°æ®è½¬ä¸ºUserDTO</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">// 7.åˆ·æ–°tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">// 8.æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p><strong>LoginInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="comment">// æ‹¦æˆª</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ‰ç”¨æˆ·ï¼Œåˆ™æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜">2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2>
<h3 id="2-1-æ·»åŠ å•†æˆ·ç¼“å­˜">2.1 æ·»åŠ å•†æˆ·ç¼“å­˜</h3>
<p>åœ¨æˆ‘ä»¬æŸ¥è¯¢å•†æˆ·ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥æ“ä½œä»æ•°æ®åº“ä¸­å»è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œå¤§è‡´é€»è¾‘æ˜¯è¿™æ ·ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“é‚£è‚¯å®šæ…¢å’¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ ç¼“å­˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯ç›´æ¥æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-1-ã€ç¼“å­˜æ¨¡å‹å’Œæ€è·¯">2.1.1 ã€ç¼“å­˜æ¨¡å‹å’Œæ€è·¯</h4>
<p>æ ‡å‡†çš„æ“ä½œæ–¹å¼å°±æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redisã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653322097736.png" alt="1653322097736"></p>
<h4 id="2-1-2ã€ä»£ç å®ç°-ä½¿ç”¨SpringCache-ç¼“å­˜åŒå†™">2.1.2ã€ä»£ç å®ç° ä½¿ç”¨SpringCache(ç¼“å­˜åŒå†™)</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = CACHE_SHOP_KEY,key = &quot;#id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Shop <span class="title function_">queryById</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = CACHE_SHOP_KEY,key = &quot;#shop.id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateShop</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateById(shop);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3ã€å®ç°cacheableè®¾ç½®ttl">2.1.3ã€å®ç°cacheableè®¾ç½®ttl</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.config;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisCacheManager <span class="title function_">cacheManager</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºObjectMapperç”¨äºå¤„ç†åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="comment">// æ³¨å†ŒJavaTimeModuleä»¥æ”¯æŒJava 8æ—¥æœŸæ—¶é—´ç±»å‹</span></span><br><span class="line">        objectMapper.registerModule(<span class="keyword">new</span> <span class="title class_">JavaTimeModule</span>());</span><br><span class="line">        <span class="comment">// ç¦ç”¨å°†æ—¥æœŸåºåˆ—åŒ–ä¸ºæ—¶é—´æˆ³æ ¼å¼ï¼Œä¿æŒå¯è¯»æ€§</span></span><br><span class="line">        objectMapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);</span><br><span class="line">        <span class="comment">// å¯ç”¨é»˜è®¤çš„å¤šæ€ç±»å‹ä¿¡æ¯å¤„ç†ï¼Œä»¥ä¾¿åœ¨ååºåˆ—åŒ–æ—¶ä¿ç•™ç±»å‹ä¿¡æ¯</span></span><br><span class="line">        objectMapper.activateDefaultTyping(</span><br><span class="line">                objectMapper.getPolymorphicTypeValidator(),</span><br><span class="line">                ObjectMapper.DefaultTyping.NON_FINAL,</span><br><span class="line">                JsonTypeInfo.As.PROPERTY</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// åˆ›å»ºé€šç”¨çš„Jackson2 JSON Redisåºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">serializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>(objectMapper);</span><br><span class="line">        <span class="comment">// å®šä¹‰é»˜è®¤çš„ç¼“å­˜é…ç½®ï¼Œè®¾ç½®ç¼“å­˜æ¡ç›®è¿‡æœŸæ—¶é—´ä¸º10åˆ†é’Ÿï¼Œå¹¶ä½¿ç”¨å®šä¹‰å¥½çš„åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">defaultConfig</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(Duration.ofMinutes(<span class="number">10</span>))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(serializer));</span><br><span class="line">        <span class="comment">// åˆ›å»ºç¼“å­˜é…ç½®æ˜ å°„ï¼Œå…è®¸ä¸ºä¸åŒçš„ç¼“å­˜åç§°å®šä¹‰ä¸åŒçš„é…ç½®</span></span><br><span class="line">        Map&lt;String, RedisCacheConfiguration&gt; cacheConfigurations = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// ä¸ºåº—é“ºç¼“å­˜è®¾ç½®å•ç‹¬çš„è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰</span></span><br><span class="line">        cacheConfigurations.put(CACHE_SHOP_KEY, defaultConfig.entryTtl(Duration.ofDays(<span class="number">1</span>)));</span><br><span class="line">        <span class="comment">// æ„å»ºRedisCacheManagerå®ä¾‹ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å’Œè‡ªå®šä¹‰çš„ç¼“å­˜é…ç½®åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> RedisCacheManager.builder(connectionFactory)</span><br><span class="line">                .cacheDefaults(defaultConfig)</span><br><span class="line">                .withInitialCacheConfigurations(cacheConfigurations)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜">2.2 è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</h3>
<p>ç¼“å­˜ç©¿é€å°±æ˜¯å› ä¸ºä¸€èˆ¬è®¾è®¡ä¸šåŠ¡çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆè®¿é—®ç¼“å­˜ä¸­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨è®¿é—®æ•°æ®åº“ï¼Œæ”»å‡»è€…å°±æ˜¯å¯ä»¥ç”¨è¿™ä¸€ç‚¹æ„é€ æ¶æ„è¯·æ±‚ï¼Œå¤šæ¬¡è®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚è¿™ç§æƒ…å†µå¯ä»¥å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ï¼Œè¿‡æ»¤éæ³•å­—ç¬¦æˆ–è€…ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤ï¼Œå†å†³å®šæ˜¯å¦è®¿é—®æ•°æ®åº“ã€‚æˆ–è€…ç»™redisè®¾ç½®nullå€¼æˆ–è€…ç©ºå­—ç¬¦ä¸²ã€‚</p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡
<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li>
<li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li>
</ul>
</li>
</ul>
</li>
<li>å¸ƒéš†è¿‡æ»¤
<ul>
<li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>å®ç°å¤æ‚</li>
<li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>**ç¼“å­˜ç©ºå¯¹è±¡æ€è·¯åˆ†æï¼š**å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†</p>
<p>**å¸ƒéš†è¿‡æ»¤ï¼š**å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œ</p>
<p>å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</p>
<p>è¿™ç§æ–¹å¼ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653326156516.png" alt="1653326156516"></p>
<h4 id="2-2-1-ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š">2.2.1 ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = CACHE_SHOP_KEY,key = &quot;#id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Shop <span class="title function_">queryById</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;    <span class="comment">//ç¼“å­˜ç©¿é€()</span></span><br><span class="line">            <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY +id,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p>
<p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404äº†ï¼Œè¿™æ ·æ˜¯ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜çš„</p>
<p>ç°åœ¨çš„é€»è¾‘ä¸­ï¼šå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 ï¼Œè¿˜æ˜¯ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©ºï¼Œæ¬§å½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œåˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653327124561.png" alt="1653327124561"></p>
<p><strong>å°æ€»ç»“ï¼š</strong></p>
<p>ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li>
</ul>
<p>ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>ç¼“å­˜nullå€¼</li>
<li>å¸ƒéš†è¿‡æ»¤</li>
<li>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</li>
<li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li>
<li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li>
<li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li>
</ul>
<h3 id="2-3-ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯">2.3 ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</h3>
<p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li>
</ul>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653327884526.png" alt="1653327884526"></p>
<h3 id="2-4-ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯">2.4 ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</h3>
<p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>äº’æ–¥é”</li>
<li>é€»è¾‘è¿‡æœŸ</li>
</ul>
<p>é€»è¾‘åˆ†æï¼šå‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ï¼Œä½†æ˜¯å‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653328022622.png" alt="1653328022622"></p>
<p>è§£å†³æ–¹æ¡ˆä¸€ã€ä½¿ç”¨é”æ¥è§£å†³ï¼š</p>
<p>å› ä¸ºé”èƒ½å®ç°äº’æ–¥æ€§ã€‚å‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹äºæ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå› ä¸ºæ­¤æ—¶ä¼šè®©æŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³• + double checkæ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p>å‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653328288627.png" alt="1653328288627"></p>
<p>è§£å†³æ–¹æ¡ˆäºŒã€é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</p>
<p>æ–¹æ¡ˆåˆ†æï¼šæˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå‡è®¾æˆ‘ä»¬ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…¶å®å°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·æ•°æ®ä¸å°±ä¸€ç›´å ç”¨æˆ‘ä»¬å†…å­˜äº†å—ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨ redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œ ä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œåªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥çš„æ„å»ºç¼“å­˜ï¼Œç¼ºç‚¹åœ¨äºåœ¨æ„å»ºå®Œç¼“å­˜ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯è„æ•°æ®ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653328663897.png" alt="1653328663897"></p>
<p>è¿›è¡Œå¯¹æ¯”</p>
<p>**äº’æ–¥é”æ–¹æ¡ˆï¼š**ç”±äºä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´ï¼Œä¸”å®ç°ç®€å•ï¼Œå› ä¸ºä»…ä»…åªéœ€è¦åŠ ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”å°±æœ‰æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä¸”åªèƒ½ä¸²è¡Œæ‰§è¡Œæ€§èƒ½è‚¯å®šå—åˆ°å½±å“</p>
<p><strong>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼š</strong> çº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆå‰ï¼Œå…¶ä»–çš„çº¿ç¨‹åªèƒ½è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œä¸”å®ç°èµ·æ¥éº»çƒ¦</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653357522914.png" alt="1653357522914"></p>
<h3 id="2-5-åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">2.5 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h3>
<p>æ ¸å¿ƒæ€è·¯ï¼šç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯ è¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœä»ç¼“å­˜æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”åï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—åˆ°äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å¾—åˆ°ï¼Œåˆ™ä¼‘çœ ï¼Œè¿‡ä¸€ä¼šå†è¿›è¡Œå°è¯•ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢</p>
<p>å¦‚æœè·å–åˆ°äº†é”çš„çº¿ç¨‹ï¼Œå†å»è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åå°†æ•°æ®å†™å…¥redisï¼Œå†é‡Šæ”¾é”ï¼Œè¿”å›æ•°æ®ï¼Œåˆ©ç”¨äº’æ–¥é”å°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œæ“ä½œæ•°æ®åº“çš„é€»è¾‘ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653357860001.png" alt="1653357860001"></p>
<p><strong>æ“ä½œé”çš„ä»£ç ï¼š</strong></p>
<p>æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨stringRedisTemplateä¸­è¿”å›trueï¼Œ  å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨stringRedisTemplateè¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ“ä½œä»£ç ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼“å­˜å‡»ç©¿ äº’æ–¥é”</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryRedis</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id; <span class="comment">//ç¼“å­˜key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopValue</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//æ˜¯å¦å­˜åœ¨ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopValue))&#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopValue, Shop.class);<span class="comment">//ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (shopValue != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;<span class="comment">//ç©ºå€¼è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    Shop shop;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!isLock)&#123;</span><br><span class="line">            <span class="comment">//æ²¡é” ç­‰å¾…</span></span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryRedis(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æˆåŠŸ</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);<span class="comment">//æ¨¡æ‹Ÿé‡å»ºå»¶è¿Ÿ</span></span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY+id,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY+id, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unLock(lockKey);<span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-6ã€åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">2.6ã€åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h3>
<p><strong>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</strong></p>
<p>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653360308731.png" alt="1653360308731"></p>
<p>å¦‚æœå°è£…æ•°æ®ï¼šå› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆä½ </p>
<p><strong>æ­¥éª¤ä¸€ã€</strong></p>
<p>æ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼Œæˆ‘ä»¬é‡‡ç”¨ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼Œå¯¹åŸæ¥ä»£ç æ²¡æœ‰ä¾µå…¥æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ­¥éª¤äºŒã€</strong></p>
<p>åœ¨<strong>ShopServiceImpl</strong> æ–°å¢æ­¤æ–¹æ³•ï¼Œåˆ©ç”¨å•å…ƒæµ‹è¯•è¿›è¡Œç¼“å­˜é¢„çƒ­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveShopRedis</span><span class="params">(Long id, Long time)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    Thread.sleep(<span class="number">200</span>);<span class="comment">//æ¨¡æ‹Ÿè€—æ—¶ çº¿ç¨‹å¹¶å‘æµ‹è¯•</span></span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(time));</span><br><span class="line">    stringRedisTemplate.opsForValue().set(RedisConstants.CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å•å…ƒæµ‹è¯•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">textSaveShop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    shopService.saveShopRedis(<span class="number">1L</span>,<span class="number">10L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ä¸‰ï¼šæ­£å¼ä»£ç </p>
<p><strong>ShopServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">( Long id )</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//æœªå‘½ä¸­ è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘½ä¸­ ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">        <span class="comment">//æœªè¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿‡æœŸ ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                <span class="built_in">this</span>.saveShopRedis(id,<span class="number">20L</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                 unLock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-7ã€å°è£…Rediså·¥å…·ç±»">2.7ã€å°è£…Rediså·¥å…·ç±»</h3>
<p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ul>
<li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li>
<li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“</li>
</ul>
<p>å­˜å‡»ç©¿é—®é¢˜</p>
<ul>
<li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li>
<li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ul>
<p>å°†é€»è¾‘è¿›è¡Œå°è£…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.utils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> CacheClient</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> CC</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@DATE</span> 2025/7/19 14:28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicalExpire</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼“å­˜å‡»ç©¿ äº’æ–¥é”</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id; <span class="comment">//ç¼“å­˜key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//æ˜¯å¦å­˜åœ¨ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);<span class="comment">//ç›´æ¥è¿”å›</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ˜¯å¦æ˜¯ç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;<span class="comment">//ç©ºå€¼è¿”å›</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span> + key;</span><br><span class="line">        R r;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">            <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">                <span class="comment">//æ²¡é” ç­‰å¾…</span></span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æˆåŠŸ</span></span><br><span class="line">            r = dbFallback.apply(id);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);<span class="comment">//æ¨¡æ‹Ÿé‡å»ºå»¶è¿Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">                stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            &#125;</span><br><span class="line">            set(key, r, time, unit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unLock(lockKey);<span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//æœªå‘½ä¸­ è¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å‘½ä¸­ ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">        <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">//æœªè¿‡æœŸ</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è¿‡æœŸ ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span> + key;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">                    <span class="type">R</span> <span class="variable">newR</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                    <span class="comment">// é‡å»ºç¼“å­˜</span></span><br><span class="line">                    <span class="built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    unLock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3ã€ä¼˜æƒ å·ç§’æ€"><strong>3ã€ä¼˜æƒ å·ç§’æ€</strong></h2>
<h3 id="3-1-å…¨å±€å”¯ä¸€ID">3.1 -å…¨å±€å”¯ä¸€ID</h3>
<p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653362612286.png" alt="1653362612286"></p>
<p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ul>
<p>åœºæ™¯åˆ†æï¼šå¦‚æœæˆ‘ä»¬çš„idå…·æœ‰å¤ªæ˜æ˜¾çš„è§„åˆ™ï¼Œç”¨æˆ·æˆ–è€…è¯´å•†ä¸šå¯¹æ‰‹å¾ˆå®¹æ˜“çŒœæµ‹å‡ºæ¥æˆ‘ä»¬çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å•†åŸåœ¨ä¸€å¤©æ—¶é—´å†…ï¼Œå–å‡ºäº†å¤šå°‘å•ï¼Œè¿™æ˜æ˜¾ä¸åˆé€‚ã€‚</p>
<p>åœºæ™¯åˆ†æäºŒï¼šéšç€æˆ‘ä»¬å•†åŸè§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œmysqlçš„å•è¡¨çš„å®¹é‡ä¸å®œè¶…è¿‡500Wï¼Œæ•°æ®é‡è¿‡å¤§ä¹‹åï¼Œæˆ‘ä»¬è¦è¿›è¡Œæ‹†åº“æ‹†è¡¨ï¼Œä½†æ‹†åˆ†è¡¨äº†ä¹‹åï¼Œä»–ä»¬ä»é€»è¾‘ä¸Šè®²ä»–ä»¬æ˜¯åŒä¸€å¼ è¡¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„idæ˜¯ä¸èƒ½ä¸€æ ·çš„ï¼Œ äºæ˜¯ä¹æˆ‘ä»¬éœ€è¦ä¿è¯idçš„å”¯ä¸€æ€§ã€‚</p>
<p><strong>å…¨å±€IDç”Ÿæˆå™¨</strong>ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653363100502.png" alt="1653363100502"></p>
<p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653363172079.png" alt="1653363172079">IDçš„ç»„æˆéƒ¨åˆ†ï¼šç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</p>
<p>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</p>
<p>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</p>
<h3 id="3-2-Rediså®ç°å…¨å±€å”¯ä¸€Id">3.2 -Rediså®ç°å…¨å±€å”¯ä¸€Id</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">// 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">// 2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ç±»</p>
<p>çŸ¥è¯†å°è´´å£«ï¼šå…³äºcountdownlatch</p>
<p>countdownlatchåä¸ºä¿¡å·æªï¼šä¸»è¦çš„ä½œç”¨æ˜¯åŒæ­¥åè°ƒåœ¨å¤šçº¿ç¨‹çš„ç­‰å¾…äºå”¤é†’é—®é¢˜</p>
<p>æˆ‘ä»¬å¦‚æœæ²¡æœ‰CountDownLatch ï¼Œé‚£ä¹ˆç”±äºç¨‹åºæ˜¯å¼‚æ­¥çš„ï¼Œå½“å¼‚æ­¥ç¨‹åºæ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œä¸»çº¿ç¨‹å°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç„¶åæˆ‘ä»¬æœŸæœ›çš„æ˜¯åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œä¹‹åï¼Œä¸»çº¿ç¨‹å†èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶éœ€è¦ä½¿ç”¨åˆ°CountDownLatch</p>
<p>CountDownLatch ä¸­æœ‰ä¸¤ä¸ªæœ€é‡è¦çš„æ–¹æ³•</p>
<p>1ã€countDown</p>
<p>2ã€await</p>
<p>await æ–¹æ³• æ˜¯é˜»å¡æ–¹æ³•ï¼Œæˆ‘ä»¬æ‹…å¿ƒåˆ†çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæ—¶ï¼Œmainçº¿ç¨‹å°±å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥ä½¿ç”¨awaitå¯ä»¥è®©mainçº¿ç¨‹é˜»å¡ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™mainçº¿ç¨‹ä¸å†é˜»å¡å‘¢ï¼Ÿå½“CountDownLatch  å†…éƒ¨ç»´æŠ¤çš„ å˜é‡å˜ä¸º0æ—¶ï¼Œå°±ä¸å†é˜»å¡ï¼Œç›´æ¥æ”¾è¡Œï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™CountDownLatch   ç»´æŠ¤çš„å˜é‡å˜ä¸º0 å‘¢ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€æ¬¡countDown ï¼Œå†…éƒ¨å˜é‡å°±å‡å°‘1ï¼Œæˆ‘ä»¬è®©åˆ†çº¿ç¨‹å’Œå˜é‡ç»‘å®šï¼Œ æ‰§è¡Œå®Œä¸€ä¸ªåˆ†çº¿ç¨‹å°±å‡å°‘ä¸€ä¸ªå˜é‡ï¼Œå½“åˆ†çº¿ç¨‹å…¨éƒ¨èµ°å®Œï¼ŒCountDownLatch ç»´æŠ¤çš„å˜é‡å°±æ˜¯0ï¼Œæ­¤æ—¶awaitå°±ä¸å†é˜»å¡ï¼Œç»Ÿè®¡å‡ºæ¥çš„æ—¶é—´ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ†çº¿ç¨‹æ‰§è¡Œå®Œåçš„æ—¶é—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testIdWorker</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id = &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</span><br><span class="line">        es.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.await();</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;time = &quot;</span> + (end - begin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-æ·»åŠ ä¼˜æƒ å·">3.3 æ·»åŠ ä¼˜æƒ å·</h3>
<p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653365145124.png" alt="1653365145124"></p>
<p>tb_voucherï¼šä¼˜æƒ åˆ¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ã€ä½¿ç”¨è§„åˆ™ç­‰<br>
tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ã€å¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ã€‚ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯</p>
<p>å¹³ä»·å·ç”±äºä¼˜æƒ åŠ›åº¦å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä»»æ„é¢†å–</p>
<p>è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§å·ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·å·é™¤äº†å…·æœ‰ä¼˜æƒ å·çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µ</p>
<p>**æ–°å¢æ™®é€šå·ä»£ç ï¼š  **VoucherController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–°å¢ç§’æ€å·ä»£ç ï¼š</strong></p>
<p><strong>VoucherController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.addSeckillVoucher(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>VoucherServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-å®ç°ç§’æ€ä¸‹å•">3.4 å®ç°ç§’æ€ä¸‹å•</h3>
<p>ä¸‹å•æ ¸å¿ƒæ€è·¯ï¼šå½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘å³ä¾§çš„è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™å¯¹åº”çš„controllerå³å¯</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653365839526.png" alt="1653365839526"></p>
<p>ç§’æ€ä¸‹å•åº”è¯¥æ€è€ƒçš„å†…å®¹ï¼š</p>
<p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li>
<li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li>
</ul>
<p>ä¸‹å•æ ¸å¿ƒé€»è¾‘åˆ†æï¼š</p>
<p>å½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶</p>
<p>æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653366238564.png" alt="1653366238564"></p>
<p>VoucherOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-åº“å­˜è¶…å–é—®é¢˜åˆ†æ">3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</h3>
<p>æœ‰å…³è¶…å–é—®é¢˜åˆ†æï¼šåœ¨æˆ‘ä»¬åŸæœ‰ä»£ç ä¸­æ˜¯è¿™ä¹ˆå†™çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">           .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">           .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">   <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">       <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">       <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653368335155.png" alt="1653368335155"></p>
<p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šè§ä¸‹å›¾ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653368562591.png" alt="1653368562591"></p>
<p><strong>æ‚²è§‚é”ï¼š</strong></p>
<p>æ‚²è§‚é”å¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚synï¼Œå’Œlockéƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç­‰ç­‰</p>
<p><strong>ä¹è§‚é”ï¼š</strong></p>
<p>ä¹è§‚é”ï¼šä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œå†æäº¤å›æ•°æ®æ—¶ï¼Œä¼šå»æ ¡éªŒæ˜¯å¦æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å¤§1 ï¼Œå¦‚æœå¤§1 ï¼Œåˆ™è¿›è¡Œæ“ä½œæˆåŠŸï¼Œè¿™å¥—æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬å·åªæ¯”åŸæ¥å¤§1 ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰äººå¯¹ä»–è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œä»–çš„æ“ä½œå°±æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å¤§1ï¼Œåˆ™æ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œå½“ç„¶ä¹è§‚é”è¿˜æœ‰ä¸€äº›å˜ç§çš„å¤„ç†æ–¹å¼æ¯”å¦‚cas</p>
<p>ä¹è§‚é”çš„å…¸å‹ä»£è¡¨ï¼šå°±æ˜¯casï¼Œåˆ©ç”¨casè¿›è¡Œæ— é”åŒ–æœºåˆ¶åŠ é”ï¼Œvar5 æ˜¯æ“ä½œå‰è¯»å–çš„å†…å­˜å€¼ï¼Œwhileä¸­çš„var1+var2 æ˜¯é¢„ä¼°å€¼ï¼Œå¦‚æœé¢„ä¼°å€¼ == å†…å­˜å€¼ï¼Œåˆ™ä»£è¡¨ä¸­é—´æ²¡æœ‰è¢«äººä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶å°±å°†æ–°å€¼å»æ›¿æ¢ å†…å­˜å€¼</p>
<p>å…¶ä¸­do while æ˜¯ä¸ºäº†åœ¨æ“ä½œå¤±è´¥æ—¶ï¼Œå†æ¬¡è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œå³æŠŠä¹‹å‰çš„é€»è¾‘å†æ“ä½œä¸€æ¬¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> var5;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">&#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> var5;</span><br></pre></td></tr></table></figure>
<p><strong>è¯¾ç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼š</strong></p>
<p>è¯¾ç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼æ˜¯æ²¡æœ‰åƒcasä¸€æ ·å¸¦è‡ªæ—‹çš„æ“ä½œï¼Œä¹Ÿæ²¡æœ‰å¯¹versionçš„ç‰ˆæœ¬å·+1 ï¼Œä»–çš„æ“ä½œé€»è¾‘æ˜¯åœ¨æ“ä½œæ—¶ï¼Œå¯¹ç‰ˆæœ¬å·è¿›è¡Œ+1 æ“ä½œï¼Œç„¶åè¦æ±‚version å¦‚æœæ˜¯1 çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½æ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œåï¼Œæ•°æ®åº“ä¸­çš„versionå˜æˆäº†2ï¼Œä½†æ˜¯ä»–è‡ªå·±æ»¡è¶³version=1 ï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜ï¼Œæ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œï¼Œçº¿ç¨‹2 æœ€åä¹Ÿéœ€è¦åŠ ä¸Šæ¡ä»¶version =1 ï¼Œä½†æ˜¯ç°åœ¨ç”±äºçº¿ç¨‹1å·²ç»æ“ä½œè¿‡äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2ï¼Œæ“ä½œæ—¶å°±ä¸æ»¡è¶³version=1 çš„æ¡ä»¶äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2æ— æ³•æ‰§è¡ŒæˆåŠŸ</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653369268550.png" alt="1653369268550"></p>
<h3 id="3-6-ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜">3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</h3>
<p><strong>ä¿®æ”¹ä»£ç æ–¹æ¡ˆä¸€ã€</strong></p>
<p>VoucherOrderServiceImpl åœ¨æ‰£å‡åº“å­˜æ—¶ï¼Œæ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>) <span class="comment">//set stock = stock -1</span></span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;stock&quot;</span>,voucher.getStock()).update(); <span class="comment">//where id = ï¼Ÿ and stock = ?</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šé€»è¾‘çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šåªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯ä»¥ä¸Šè¿™ç§æ–¹å¼é€šè¿‡æµ‹è¯•å‘ç°ä¼šæœ‰å¾ˆå¤šå¤±è´¥çš„æƒ…å†µï¼Œå¤±è´¥çš„åŸå› åœ¨äºï¼šåœ¨ä½¿ç”¨ä¹è§‚é”è¿‡ç¨‹ä¸­å‡è®¾100ä¸ªçº¿ç¨‹åŒæ—¶éƒ½æ‹¿åˆ°äº†100çš„åº“å­˜ï¼Œç„¶åå¤§å®¶ä¸€èµ·å»è¿›è¡Œæ‰£å‡ï¼Œä½†æ˜¯100ä¸ªäººä¸­åªæœ‰1ä¸ªäººèƒ½æ‰£å‡æˆåŠŸï¼Œå…¶ä»–çš„äººåœ¨å¤„ç†æ—¶ï¼Œä»–ä»¬åœ¨æ‰£å‡æ—¶ï¼Œåº“å­˜å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œæ‰€ä»¥æ­¤æ—¶å…¶ä»–çº¿ç¨‹éƒ½ä¼šå¤±è´¥</p>
<p><strong>ä¿®æ”¹ä»£ç æ–¹æ¡ˆäºŒã€</strong></p>
<p>ä¹‹å‰çš„æ–¹å¼è¦ä¿®æ”¹å‰åéƒ½ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯è¿™æ ·æˆ‘ä»¬åˆ†æè¿‡ï¼ŒæˆåŠŸçš„æ¦‚ç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆstockå¤§äº0 å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>); <span class="comment">//where id = ? and stock &gt; 0</span></span><br></pre></td></tr></table></figure>
<p><strong>çŸ¥è¯†å°æ‰©å±•ï¼š</strong></p>
<p>é’ˆå¯¹casä¸­çš„è‡ªæ—‹å‹åŠ›è¿‡å¤§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Longaddrè¿™ä¸ªç±»å»è§£å†³</p>
<p>Java8 æä¾›çš„ä¸€ä¸ªå¯¹AtomicLongæ”¹è¿›åçš„ä¸€ä¸ªç±»ï¼ŒLongAdder</p>
<p>å¤§é‡çº¿ç¨‹å¹¶å‘æ›´æ–°ä¸€ä¸ªåŸå­æ€§çš„æ—¶å€™ï¼Œå¤©ç„¶çš„é—®é¢˜å°±æ˜¯è‡ªæ—‹ï¼Œä¼šå¯¼è‡´å¹¶å‘æ€§é—®é¢˜ï¼Œå½“ç„¶è¿™ä¹Ÿæ¯”æˆ‘ä»¬ç›´æ¥ä½¿ç”¨synæ¥çš„å¥½</p>
<p>æ‰€ä»¥åˆ©ç”¨è¿™ä¹ˆä¸€ä¸ªç±»ï¼ŒLongAdderæ¥è¿›è¡Œä¼˜åŒ–</p>
<p>å¦‚æœè·å–æŸä¸ªå€¼ï¼Œåˆ™ä¼šå¯¹cellå’Œbaseçš„å€¼è¿›è¡Œé€’å¢ï¼Œæœ€åè¿”å›ä¸€ä¸ªå®Œæ•´çš„å€¼</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653370271627.png" alt="1653370271627"></p>
<h3 id="3-6-ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•">3.6 ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•</h3>
<p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p>
<p><strong>ç°åœ¨çš„é—®é¢˜åœ¨äºï¼š</strong></p>
<p>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•</p>
<p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653371854389.png" alt="1653371854389"></p>
<p>VoucherOrderServiceImpl</p>
<p><strong>åˆæ­¥ä»£ç ï¼šå¢åŠ ä¸€äººä¸€å•é€»è¾‘</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="comment">// 5.1.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å­˜åœ¨é—®é¢˜</strong>:ç°åœ¨çš„é—®é¢˜è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œå¹¶å‘è¿‡æ¥ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œéƒ½ä¸å­˜åœ¨è®¢å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œ</p>
<p>**æ³¨æ„:**åœ¨è¿™é‡Œæåˆ°äº†éå¸¸å¤šçš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ…¢æ…¢çš„æ¥æ€è€ƒï¼Œé¦–å…ˆæˆ‘ä»¬çš„åˆå§‹æ–¹æ¡ˆæ˜¯å°è£…äº†ä¸€ä¸ªcreateVoucherOrderæ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ç¡®ä¿ä»–çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ï¼Œä½†æ˜¯è¿™æ ·æ·»åŠ é”ï¼Œé”çš„ç²’åº¦å¤ªç²—äº†ï¼Œåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶<strong>é”ç²’åº¦</strong> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ§åˆ¶é”çš„ç²’åº¦ï¼Œä»¥ä¸‹è¿™æ®µä»£ç éœ€è¦ä¿®æ”¹ä¸ºï¼š<br>
intern() è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">	<span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä»¥ä¸Šä»£ç è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œé—®é¢˜çš„åŸå› åœ¨äºå½“å‰æ–¹æ³•è¢«springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©å°†å½“å‰æ–¹æ³•æ•´ä½“åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿äº‹åŠ¡ä¸ä¼šå‡ºç°é—®é¢˜ï¼šå¦‚ä¸‹ï¼š</p>
<p>åœ¨seckillVoucher æ–¹æ³•ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼Œè¿™æ ·å°±èƒ½ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿæ§åˆ¶äº†é”çš„ç²’åº¦</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653373434815.png" alt="1653373434815"></p>
<p>ä½†æ˜¯ä»¥ä¸Šåšæ³•ä¾ç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºä½ è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶å®æ˜¯this.çš„æ–¹å¼è°ƒç”¨çš„ï¼Œäº‹åŠ¡æƒ³è¦ç”Ÿæ•ˆï¼Œè¿˜å¾—åˆ©ç”¨ä»£ç†æ¥ç”Ÿæ•ˆï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—åŸå§‹çš„äº‹åŠ¡å¯¹è±¡ï¼Œ æ¥æ“ä½œäº‹åŠ¡</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653383810643.png" alt="1653383810643"></p>
<h3 id="3-7-é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">3.7 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h3>
<p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ã€‚</p>
<p>1ã€æˆ‘ä»¬å°†æœåŠ¡å¯åŠ¨ä¸¤ä»½ï¼Œç«¯å£åˆ†åˆ«ä¸º8081å’Œ8082ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653373887844.png" alt="1653373887844"></p>
<p>2ã€ç„¶åä¿®æ”¹nginxçš„confç›®å½•ä¸‹çš„nginx.confæ–‡ä»¶ï¼Œé…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653373908620.png" alt="1653373908620"></p>
<p><strong>å…·ä½“æ“ä½œ(ç•¥)</strong></p>
<p><strong>æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ</strong></p>
<p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653374044740.png" alt="1653374044740"></p>
<h2 id="4ã€åˆ†å¸ƒå¼é”"><strong>4ã€åˆ†å¸ƒå¼é”</strong></h2>
<h3 id="4-1-ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”">4.1 ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h3>
<p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</p>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653374296906.png" alt="1653374296906"></p>
<p>é‚£ä¹ˆåˆ†å¸ƒå¼é”ä»–åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</p>
<p>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</p>
<p>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</p>
<p>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</p>
<p>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</p>
<p>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653381992018.png" alt="1653381992018"></p>
<p>å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</p>
<p>Mysqlï¼šmysqlæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºmysqlæ€§èƒ½æœ¬èº«ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œå…¶å®ä½¿ç”¨mysqlä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</p>
<p>Redisï¼šredisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½ä½¿ç”¨redisæˆ–è€…zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨setnxè¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥keyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œå…¶ä»–äººæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å¾—åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°åˆ†å¸ƒå¼é”</p>
<p>Zookeeperï¼šzookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œç”±äºæœ¬å¥—è§†é¢‘å¹¶ä¸è®²è§£zookeeperçš„åŸç†å’Œåˆ†å¸ƒå¼é”çš„å®ç°ï¼Œæ‰€ä»¥ä¸è¿‡å¤šé˜è¿°</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653382219377.png" alt="1653382219377"></p>
<h3 id="4-2-ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯">4.2 ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</h3>
<p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<ul>
<li>
<p>è·å–é”ï¼š</p>
<ul>
<li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li>
<li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li>
</ul>
</li>
<li>
<p>é‡Šæ”¾é”ï¼š</p>
<ul>
<li>æ‰‹åŠ¨é‡Šæ”¾</li>
<li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</li>
</ul>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653382669900.png" alt="1653382669900"></p>
</li>
</ul>
<p>æ ¸å¿ƒæ€è·¯ï¼š</p>
<p>æˆ‘ä»¬åˆ©ç”¨redis çš„setNx æ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653382830810.png" alt="1653382830810"></p>
<h3 id="4-3-å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€">4.3 å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</h3>
<ul>
<li>åŠ é”é€»è¾‘</li>
</ul>
<p><strong>é”çš„åŸºæœ¬æ¥å£</strong></p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1656079017728.png" alt="1656079017728"></p>
<p><strong>SimpleRedisLock</strong></p>
<p>åˆ©ç”¨setnxæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶å¢åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œæ­¤æ–¹æ³•å¯ä»¥ä¿è¯åŠ é”å’Œå¢åŠ è¿‡æœŸæ—¶é—´å…·æœ‰åŸå­æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX=<span class="string">&quot;lock:&quot;</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId()</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é‡Šæ”¾é”é€»è¾‘</li>
</ul>
<p>SimpleRedisLock</p>
<p>é‡Šæ”¾é”ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡delåˆ é™¤é”</span></span><br><span class="line">    stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¿®æ”¹ä¸šåŠ¡ä»£ç </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">      <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">      <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">      <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">          <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">          <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">      <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">      <span class="comment">//åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç )</span></span><br><span class="line">      <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">      <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line"><span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">      <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">          <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">          <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">          <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">          lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜">4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</h3>
<p>é€»è¾‘è¯´æ˜ï¼š</p>
<p>æŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p>
<p>è§£å†³æ–¹æ¡ˆï¼šè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤ï¼Œå‡è®¾è¿˜æ˜¯ä¸Šè¾¹çš„æƒ…å†µï¼Œçº¿ç¨‹1å¡é¡¿ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç„¶ååˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1ï¼Œä¸€çœ‹å½“å‰è¿™æŠŠé”ä¸æ˜¯å±äºè‡ªå·±ï¼Œäºæ˜¯ä¸è¿›è¡Œåˆ é™¤é”é€»è¾‘ï¼Œå½“çº¿ç¨‹2èµ°åˆ°åˆ é™¤é”é€»è¾‘æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¡è¿‡è‡ªåŠ¨é‡Šæ”¾é”çš„æ—¶é—´ç‚¹ï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å±äºè‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653385920025.png" alt="1653385920025"></p>
<h3 id="4-5-è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜">4.5 è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h3>
<p>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼šåœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰<br>
åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</p>
<ul>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li>
</ul>
<p>æ ¸å¿ƒé€»è¾‘ï¼šåœ¨å­˜å…¥é”æ—¶ï¼Œæ”¾å…¥è‡ªå·±çº¿ç¨‹çš„æ ‡è¯†ï¼Œåœ¨åˆ é™¤é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”çš„æ ‡è¯†æ˜¯ä¸æ˜¯è‡ªå·±å­˜å…¥çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653387398820.png" alt="1653387398820"></p>
<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼šåŠ é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">   <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">   <span class="comment">// è·å–é”</span></span><br><span class="line">   <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">   <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­çš„æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span>(threadId.equals(id)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æœ‰å…³ä»£ç å®æ“è¯´æ˜ï¼š</strong></p>
<p>åœ¨æˆ‘ä»¬ä¿®æ”¹å®Œæ­¤å¤„ä»£ç åï¼Œæˆ‘ä»¬é‡å¯å·¥ç¨‹ï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”åï¼Œæ‰‹åŠ¨é‡Šæ”¾é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ æ­¤æ—¶è¿›å…¥åˆ°é”å†…éƒ¨ï¼Œå†æ”¾è¡Œç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªçº¿ç¨‹ç”±äºé”çš„valueå€¼å¹¶éæ˜¯è‡ªå·±ï¼Œæ‰€ä»¥ä¸èƒ½é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ— æ³•åˆ é™¤åˆ«äººçš„é”ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®é‡Šæ”¾é”ï¼Œé€šè¿‡è¿™ä¸ªæ¡ˆä¾‹åˆæ­¥è¯´æ˜æˆ‘ä»¬è§£å†³äº†é”è¯¯åˆ çš„é—®é¢˜ã€‚</p>
<h3 id="4-6-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">4.6 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3>
<p>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜ï¼š</p>
<p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬è¦é˜²æ­¢åˆšæ‰çš„æƒ…å†µå‘ç”Ÿï¼Œ</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653387764938.png" alt="1653387764938"></p>
<h3 id="4-7-Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜">4.7 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3>
<p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¤§å®¶å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html%EF%BC%8C%E8%BF%99%E9%87%8C%E9%87%8D%E7%82%B9%E4%BB%8B%E7%BB%8DRedis%E6%8F%90%E4%BE%9B%E7%9A%84%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E5%8E%BB%E6%93%8D%E4%BD%9Credis%EF%BC%8C%E5%8F%88%E8%83%BD%E4%BF%9D%E8%AF%81%E4%BB%96%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E6%8B%BF%E9%94%81%E6%AF%94%E9%94%81%E5%88%A0%E9%94%81%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E6%80%A7%E5%8A%A8%E4%BD%9C%E4%BA%86%EF%BC%8C%E4%BD%9C%E4%B8%BAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E8%BF%99%E4%B8%80%E5%9D%97%E5%B9%B6%E4%B8%8D%E4%BD%9C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E8%A6%81%E6%B1%82%EF%BC%8C%E5%B9%B6%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%A7%E5%AE%B6%E8%BF%87%E4%BA%8E%E7%B2%BE%E9%80%9A%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%96%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%E5%8D%B3%E5%8F%AF%E3%80%82">https://www.runoob.com/lua/lua-tutorial.htmlï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaå»æ“ä½œredisï¼Œåˆèƒ½ä¿è¯ä»–çš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†ï¼Œä½œä¸ºJavaç¨‹åºå‘˜è¿™ä¸€å—å¹¶ä¸ä½œä¸€ä¸ªç®€å•è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å¤§å®¶è¿‡äºç²¾é€šï¼Œåªéœ€è¦çŸ¥é“ä»–æœ‰ä»€ä¹ˆä½œç”¨å³å¯ã€‚</a></p>
<p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆæ‰§è¡Œ set name jack</span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"># å†æ‰§è¡Œ get name</span><br><span class="line"><span class="keyword">local</span> name = redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"># è¿”å›</span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure>
<p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨Rediså‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653392181413.png" alt="1653392181413"></p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œ redis.call(â€˜setâ€™, â€˜nameâ€™, â€˜jackâ€™) è¿™ä¸ªè„šæœ¬ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653392218531.png" alt="1653392218531"></p>
<p>å¦‚æœè„šæœ¬ä¸­çš„keyã€valueä¸æƒ³å†™æ­»ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚keyç±»å‹å‚æ•°ä¼šæ”¾å…¥KEYSæ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ARGVæ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­å¯ä»¥ä»KEYSå’ŒARGVæ•°ç»„è·å–è¿™äº›å‚æ•°ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653392438917.png" alt="1653392438917"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼š</p>
<p>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„</p>
<p>â€‹	1ã€è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</p>
<p>â€‹	2ã€åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´</p>
<p>â€‹	3ã€å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰</p>
<p>â€‹	4ã€å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</p>
<p>å¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼š</p>
<p>æœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="4-8-åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”">4.8 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</h3>
<p>luaè„šæœ¬æœ¬èº«å¹¶ä¸éœ€è¦å¤§å®¶èŠ±è´¹å¤ªå¤šæ—¶é—´å»ç ”ç©¶ï¼Œåªéœ€è¦çŸ¥é“å¦‚ä½•è°ƒç”¨ï¼Œå¤§è‡´æ˜¯ä»€ä¹ˆæ„æ€å³å¯ï¼Œæ‰€ä»¥åœ¨ç¬”è®°ä¸­å¹¶ä¸ä¼šè¯¦ç»†çš„å»è§£é‡Šè¿™äº›luaè¡¨è¾¾å¼çš„å«ä¹‰ã€‚</p>
<p>æˆ‘ä»¬çš„RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬ï¼Œå‚æ•°å¯¹åº”å…³ç³»å°±å¦‚ä¸‹å›¾è‚¡</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653393304844.png" alt="1653393304844"></p>
<p><strong>Javaä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨luaè„šæœ¬</span></span><br><span class="line">    stringRedisTemplate.execute(</span><br><span class="line">            UNLOCK_SCRIPT,</span><br><span class="line">            Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">            ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">&#125;</span><br><span class="line">ç»è¿‡ä»¥ä¸Šä»£ç æ”¹é€ åï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå®ç° æ‹¿é”æ¯”é”åˆ é”çš„åŸå­æ€§åŠ¨ä½œäº†~</span><br></pre></td></tr></table></figure>
<p>å°æ€»ç»“ï¼š</p>
<p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p>
<ul>
<li>åˆ©ç”¨set nx exè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”
<ul>
<li>ç‰¹æ€§ï¼š
<ul>
<li>åˆ©ç”¨set nxæ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨set exä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ç¬”è€…æ€»ç»“ï¼šæˆ‘ä»¬ä¸€è·¯èµ°æ¥ï¼Œåˆ©ç”¨æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä½†æ˜¯æœ‰äº†è¿‡æœŸæ—¶é—´ä¹‹åï¼Œå¯èƒ½å‡ºç°è¯¯åˆ åˆ«äººé”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼€å§‹æ˜¯åˆ©ç”¨åˆ ä¹‹å‰ é€šè¿‡æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”è¿™ä¸ªé€»è¾‘æ¥è§£å†³çš„ï¼Œä¹Ÿå°±æ˜¯åˆ ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æœ‰åŸå­æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡æ³•ä¿è¯æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œï¼Œæœ€åé€šè¿‡luaè¡¨è¾¾å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<p>ä½†æ˜¯ç›®å‰è¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜é”ä¸ä½ï¼Œä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œå¦‚æœå½“è¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œ ç½‘è´¹åˆ°äº†ä¹‹åï¼Œç„¶åè¯´ï¼Œæ¥ï¼Œç½‘ç®¡ï¼Œå†ç»™æˆ‘æ¥10å—çš„ï¼Œæ˜¯ä¸æ˜¯åè¾¹çš„é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ redissionå•¦</p>
<p><strong>æµ‹è¯•é€»è¾‘ï¼š</strong></p>
<p>ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼Œå¾—åˆ°äº†é”ï¼Œæ‰‹åŠ¨åˆ é™¤é”ï¼Œæ¨¡æ‹Ÿé”è¶…æ—¶äº†ï¼Œå…¶ä»–çº¿ç¨‹ä¼šæ‰§è¡Œluaæ¥æŠ¢é”ï¼Œå½“ç¬¬ä¸€å¤©çº¿ç¨‹åˆ©ç”¨luaåˆ é™¤é”æ—¶ï¼Œluaèƒ½ä¿è¯ä»–ä¸èƒ½åˆ é™¤ä»–çš„é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ é™¤é”æ—¶ï¼Œåˆ©ç”¨luaåŒæ ·å¯ä»¥ä¿è¯ä¸ä¼šåˆ é™¤åˆ«äººçš„é”ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯åŸå­æ€§ã€‚</p>
<h2 id="5ã€åˆ†å¸ƒå¼é”-redission"><strong>5ã€åˆ†å¸ƒå¼é”-redission</strong></h2>
<h3 id="5-1-åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»">5.1 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</h3>
<p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<p><strong>é‡å…¥é—®é¢˜</strong>ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ï¼Œæ¯”å¦‚HashTableè¿™æ ·çš„ä»£ç ä¸­ï¼Œä»–çš„æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨synchronizedä¿®é¥°çš„ï¼Œå‡å¦‚ä»–åœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœæ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸å°±æ­»é”äº†å—ï¼Ÿæ‰€ä»¥å¯é‡å…¥é”ä»–çš„ä¸»è¦æ„ä¹‰æ˜¯é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬çš„synchronizedå’ŒLocké”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚</p>
<p><strong>ä¸å¯é‡è¯•</strong>ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œæˆ‘ä»¬è®¤ä¸ºåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</p>
<p>**è¶…æ—¶é‡Šæ”¾ï¼š**æˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</p>
<p><strong>ä¸»ä»ä¸€è‡´æ€§ï¼š</strong> å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•æœºäº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653546070602.png" alt="1653546070602"></p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯Redissionå‘¢</p>
<p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p>
<p>Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653546736063.png" alt="1653546736063"></p>
<h3 id="5-2-åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨">5.2 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨</h3>
<p>å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;redisson&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">3.13</span><span class="number">.6</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>é…ç½®Redissonå®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•ä½¿ç”¨Redissionçš„åˆ†å¸ƒå¼é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissionClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          </span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ VoucherOrderServiceImpl</p>
<p>æ³¨å…¥RedissonClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">       </span><br><span class="line">		<span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†">5.3 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†</h3>
<p>åœ¨Locké”ä¸­ï¼Œä»–æ˜¯å€ŸåŠ©äºåº•å±‚çš„ä¸€ä¸ªvoaltileçš„ä¸€ä¸ªstateå˜é‡æ¥è®°å½•é‡å…¥çš„çŠ¶æ€çš„ï¼Œæ¯”å¦‚å½“å‰æ²¡æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate=0ï¼Œå‡å¦‚æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate=1ï¼Œå¦‚æœæŒæœ‰è¿™æŠŠé”çš„äººå†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstateå°±ä¼š+1 ï¼Œå¦‚æœæ˜¯å¯¹äºsynchronizedè€Œè¨€ï¼Œä»–åœ¨cè¯­è¨€ä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ªcountï¼ŒåŸç†å’Œstateç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡å…¥ä¸€æ¬¡å°±åŠ ä¸€ï¼Œé‡Šæ”¾ä¸€æ¬¡å°±-1 ï¼Œç›´åˆ°å‡å°‘æˆ0 æ—¶ï¼Œè¡¨ç¤ºå½“å‰è¿™æŠŠé”æ²¡æœ‰è¢«äººæŒæœ‰ã€‚</p>
<p>åœ¨redissionä¸­ï¼Œæˆ‘ä»¬çš„ä¹Ÿæ”¯æŒæ”¯æŒå¯é‡å…¥é”</p>
<p>åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œä»–é‡‡ç”¨hashç»“æ„ç”¨æ¥å­˜å‚¨é”ï¼Œå…¶ä¸­å¤§keyè¡¨ç¤ºè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œç”¨å°keyè¡¨ç¤ºå½“å‰è¿™æŠŠé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹å½“å‰çš„è¿™ä¸ªluaè¡¨è¾¾å¼</p>
<p>è¿™ä¸ªåœ°æ–¹ä¸€å…±æœ‰3ä¸ªå‚æ•°</p>
<blockquote>
<p><strong>KEYS[1] ï¼š é”åç§°</strong></p>
<p><strong>ARGV[1]ï¼š  é”å¤±æ•ˆæ—¶é—´</strong></p>
<p><strong>ARGV[2]ï¼š  id + â€œ:â€ + threadId; é”çš„å°key</strong></p>
</blockquote>
<blockquote>
<ul>
<li>è¯´ç™½äº†ï¼Œå…ˆåˆ¤æ–­é”å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±ï¼Œè¯´æ˜æ˜¯é¦–æ¬¡æ“ä½œåˆ›å»ºé”ï¼Œè‹¥ä¸»é”å­˜åœ¨ï¼Œä¸”å“ˆå¸Œè¡¨ä¸­å­˜åœ¨å½“å‰çº¿ç¨‹çš„æ ‡è¯†ï¼ˆ<code>ARGV[2]</code>ï¼‰ï¼Œè¯´æ˜æ˜¯<strong>åŒä¸€çº¿ç¨‹å†æ¬¡è¯·æ±‚é”</strong>ï¼ˆå¯é‡å…¥åœºæ™¯ï¼‰å°†é‡å…¥æ¬¡æ•°+1ï¼Œå†è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚è¿”å›nilè¡¨ç¤ºé‡å…¥é”æˆåŠŸã€‚é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰çš„æ—¶å€™ return redis.call(â€˜pttlâ€™, KEYS[1]);</li>
</ul>
</blockquote>
<p>exists: åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨  nameï¼šæ˜¯lockæ˜¯å¦å­˜åœ¨,å¦‚æœ==0ï¼Œå°±è¡¨ç¤ºå½“å‰è¿™æŠŠé”ä¸å­˜åœ¨</p>
<p>redis.call(â€˜hsetâ€™, KEYS[1], ARGV[2], 1);æ­¤æ—¶ä»–å°±å¼€å§‹å¾€redisé‡Œè¾¹å»å†™æ•°æ® ï¼Œå†™æˆä¸€ä¸ªhashç»“æ„</p>
<p>Lock{</p>
<p>â€‹    id + <strong>â€œ:â€</strong> + threadId :  1</p>
<p>}</p>
<p>å¦‚æœå½“å‰è¿™æŠŠé”å­˜åœ¨ï¼Œåˆ™ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œå†åˆ¤æ–­</p>
<p>redis.call(â€˜hexistsâ€™, KEYS[1], ARGV[2]) == 1</p>
<p>æ­¤æ—¶éœ€è¦é€šè¿‡å¤§key+å°keyåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ï¼Œåˆ™è¿›è¡Œ</p>
<p>redis.call(â€˜hincrbyâ€™, KEYS[1], ARGV[2], 1)</p>
<p>å°†å½“å‰è¿™ä¸ªé”çš„valueè¿›è¡Œ+1 ï¼Œredis.call(â€˜pexpireâ€™, KEYS[1], ARGV[1]); ç„¶åå†å¯¹å…¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¡¨ç¤ºå½“å‰è¿™æŠŠé”æŠ¢é”å¤±è´¥ï¼Œæœ€åè¿”å›pttlï¼Œå³ä¸ºå½“å‰è¿™æŠŠé”çš„å¤±æ•ˆæ—¶é—´</p>
<p>å¦‚æœå°ä¼™å¸®ä»¬çœ‹äº†å‰è¾¹çš„æºç ï¼Œ ä½ ä¼šå‘ç°ä»–ä¼šå»åˆ¤æ–­å½“å‰è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™å¯¹åº”åˆ™å‰ä¸¤ä¸ªifå¯¹åº”çš„æ¡ä»¶ï¼Œé€€å‡ºæŠ¢é”é€»è¾‘ï¼Œå¦‚æœè¿”å›çš„ä¸æ˜¯nullï¼Œå³èµ°äº†ç¬¬ä¸‰ä¸ªåˆ†æ”¯ï¼Œåœ¨æºç å¤„ä¼šè¿›è¡Œwhile(true)çš„è‡ªæ—‹æŠ¢é”ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hset&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">              <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653548087334.png" alt="1653548087334"></p>
<h3 id="5-4-åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶">5.4 åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</h3>
<p><strong>è¯´æ˜</strong>ï¼šç”±äºè¯¾ç¨‹ä¸­å·²ç»è¯´æ˜äº†æœ‰å…³tryLockçš„æºç è§£æä»¥åŠå…¶çœ‹é—¨ç‹—åŸç†ï¼Œæ‰€ä»¥ç¬”è€…åœ¨è¿™é‡Œç»™å¤§å®¶åˆ†ælock()æ–¹æ³•çš„æºç è§£æï¼Œå¸Œæœ›å¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œèƒ½å¤ŸæŒæ¡æ›´å¤šçš„çŸ¥è¯†</p>
<p>æŠ¢é”è¿‡ç¨‹ä¸­ï¼Œè·å¾—å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡tryAcquireè¿›è¡ŒæŠ¢é”ï¼Œè¯¥æŠ¢é”é€»è¾‘å’Œä¹‹å‰é€»è¾‘ç›¸åŒ</p>
<p>1ã€å…ˆåˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæ’å…¥ä¸€æŠŠé”ï¼Œè¿”å›null</p>
<p>2ã€åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›null</p>
<p>æ‰€ä»¥å¦‚æœè¿”å›æ˜¯nullï¼Œåˆ™ä»£è¡¨ç€å½“å‰è¿™å“¥ä»¬å·²ç»æŠ¢é”å®Œæ¯•ï¼Œæˆ–è€…å¯é‡å…¥å®Œæ¯•ï¼Œä½†æ˜¯å¦‚æœä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¿›å…¥åˆ°ç¬¬ä¸‰ä¸ªæ¡ä»¶ï¼Œè¿”å›çš„æ˜¯é”çš„å¤±æ•ˆæ—¶é—´ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªè¡Œå¾€ä¸‹ç¿»ä¸€ç‚¹ç‚¹ï¼Œä½ èƒ½å‘ç°æœ‰ä¸ªwhile( true) å†æ¬¡è¿›è¡ŒtryAcquireè¿›è¡ŒæŠ¢é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line"><span class="type">Long</span> <span class="variable">ttl</span> <span class="operator">=</span> tryAcquire(-<span class="number">1</span>, leaseTime, unit, threadId);</span><br><span class="line"><span class="comment">// lock acquired</span></span><br><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä¼šæœ‰ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ï¼Œå› ä¸ºlockæ–¹æ³•æœ‰é‡è½½æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¸¦å‚æ•°ï¼Œä¸€ä¸ªæ˜¯ä¸å¸¦å‚æ•°ï¼Œå¦‚æœå¸¦å¸¦å‚æ•°ä¼ å…¥çš„å€¼æ˜¯-1ï¼Œå¦‚æœä¼ å…¥å‚æ•°ï¼Œåˆ™leaseTimeæ˜¯ä»–æœ¬èº«ï¼Œæ‰€ä»¥å¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œæ­¤æ—¶leaseTime != -1 åˆ™ä¼šè¿›å»æŠ¢é”ï¼ŒæŠ¢é”çš„é€»è¾‘å°±æ˜¯ä¹‹å‰è¯´çš„é‚£ä¸‰ä¸ªé€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (leaseTime != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æ²¡æœ‰ä¼ å…¥æ—¶é—´ï¼Œåˆ™æ­¤æ—¶ä¹Ÿä¼šè¿›è¡ŒæŠ¢é”ï¼Œ è€Œä¸”æŠ¢é”æ—¶é—´æ˜¯é»˜è®¤çœ‹é—¨ç‹—æ—¶é—´ commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout()</p>
<p>ttlRemainingFuture.onComplete((ttlRemaining, e) è¿™å¥è¯ç›¸å½“äºå¯¹ä»¥ä¸ŠæŠ¢é”è¿›è¡Œäº†ç›‘å¬ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸Šè¾¹æŠ¢é”å®Œæ¯•åï¼Œæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå…·ä½“è°ƒç”¨çš„é€»è¾‘å°±æ˜¯å»åå°å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿›è¡Œç»­çº¦é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯çœ‹é—¨ç‹—çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RFuture&lt;Long&gt; ttlRemainingFuture = tryLockInnerAsync(waitTime,</span><br><span class="line">                                        commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(),</span><br><span class="line">                                        TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);</span><br><span class="line">ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lock acquired</span></span><br><span class="line">    <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span><br><span class="line">        scheduleExpirationRenewal(threadId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> ttlRemainingFuture;</span><br></pre></td></tr></table></figure>
<p>æ­¤é€»è¾‘å°±æ˜¯ç»­çº¦é€»è¾‘ï¼Œæ³¨æ„çœ‹commandExecutor.getConnectionManager().newTimeoutï¼ˆï¼‰ æ­¤æ–¹æ³•</p>
<p>Method(  <strong>new</strong> TimerTask() {},å‚æ•°2 ï¼Œå‚æ•°3  )</p>
<p>æŒ‡çš„æ˜¯ï¼šé€šè¿‡å‚æ•°2ï¼Œå‚æ•°3 å»æè¿°ä»€ä¹ˆæ—¶å€™å»åšå‚æ•°1çš„äº‹æƒ…ï¼Œç°åœ¨çš„æƒ…å†µæ˜¯ï¼š10sä¹‹åå»åšå‚æ•°ä¸€çš„äº‹æƒ…</p>
<p>å› ä¸ºé”çš„å¤±æ•ˆæ—¶é—´æ˜¯30sï¼Œå½“10sä¹‹åï¼Œæ­¤æ—¶è¿™ä¸ªtimeTask å°±è§¦å‘äº†ï¼Œä»–å°±å»è¿›è¡Œç»­çº¦ï¼ŒæŠŠå½“å‰è¿™æŠŠé”ç»­çº¦æˆ30sï¼Œå¦‚æœæ“ä½œæˆåŠŸï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šé€’å½’è°ƒç”¨è‡ªå·±ï¼Œå†é‡æ–°è®¾ç½®ä¸€ä¸ªtimeTask()ï¼Œäºæ˜¯å†è¿‡10sååˆå†è®¾ç½®ä¸€ä¸ªtimerTaskï¼Œå®Œæˆä¸åœçš„ç»­çº¦</p>
<p>é‚£ä¹ˆå¤§å®¶å¯ä»¥æƒ³ä¸€æƒ³ï¼Œå‡è®¾æˆ‘ä»¬çš„çº¿ç¨‹å‡ºç°äº†å®•æœºä»–è¿˜ä¼šç»­çº¦å—ï¼Ÿå½“ç„¶ä¸ä¼šï¼Œå› ä¸ºæ²¡æœ‰äººå†å»è°ƒç”¨renewExpirationè¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ç­‰åˆ°æ—¶é—´ä¹‹åè‡ªç„¶å°±é‡Šæ”¾äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">ee</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (ee == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">ExpirationEntry</span> <span class="variable">ent</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">            <span class="keyword">if</span> (ent == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">threadId</span> <span class="operator">=</span> ent.getFirstThreadId();</span><br><span class="line">            <span class="keyword">if</span> (threadId == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            RFuture&lt;Boolean&gt; future = renewExpirationAsync(threadId);</span><br><span class="line">            future.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Can&#x27;t update lock &quot;</span> + getName() + <span class="string">&quot; expiration&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                    <span class="comment">// reschedule itself</span></span><br><span class="line">                    renewExpiration();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    </span><br><span class="line">    ee.setTimeout(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†">5.5 åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†</h3>
<p>ä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p>
<p>æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653553998403.png" alt="1653553998403"></p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œredissionæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653554055048.png" alt="1653554055048"></p>
<p>é‚£ä¹ˆMutiLock åŠ é”åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬”è€…ç”»äº†ä¸€å¹…å›¾æ¥è¯´æ˜</p>
<p>å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼Œredissionä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦åŠ é”çš„ä¸ªæ•° * 1500ms ï¼Œå‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œ é‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•.</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653553093967.png" alt="1653553093967"></p>
<h2 id="6ã€ç§’æ€ä¼˜åŒ–"><strong>6ã€ç§’æ€ä¼˜åŒ–</strong></h2>
<h3 id="6-1-ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯">6.1 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯</h3>
<p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</p>
<p>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šè¯·æ±‚nginxï¼Œnginxä¼šè®¿é—®åˆ°tomcatï¼Œè€Œtomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<p>1ã€æŸ¥è¯¢ä¼˜æƒ å·</p>
<p>2ã€åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</p>
<p>3ã€æŸ¥è¯¢è®¢å•</p>
<p>4ã€æ ¡éªŒæ˜¯å¦æ˜¯ä¸€äººä¸€å•</p>
<p>5ã€æ‰£å‡åº“å­˜</p>
<p>6ã€åˆ›å»ºè®¢å•</p>
<p>åœ¨è¿™å…­æ­¥æ“ä½œä¸­ï¼Œåˆæœ‰å¾ˆå¤šæ“ä½œæ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ è¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</p>
<p>åœ¨è¿™é‡Œç¬”è€…æƒ³ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹è¯¾ç¨‹å†…æ²¡æœ‰çš„æ€è·¯ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å°ä¼™ä¼´è¿™ä¹ˆæƒ³ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¯ä»¥ä½¿ç”¨å¼‚æ­¥ç¼–æ’æ¥åšï¼Œæˆ–è€…è¯´æˆ‘å¼€å¯Nå¤šçº¿ç¨‹ï¼ŒNå¤šä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢ä¼˜æƒ å·ï¼Œä¸€ä¸ªæ‰§è¡Œåˆ¤æ–­æ‰£å‡åº“å­˜ï¼Œä¸€ä¸ªå»åˆ›å»ºè®¢å•ç­‰ç­‰ï¼Œç„¶åå†ç»Ÿä¸€åšè¿”å›ï¼Œè¿™ç§åšæ³•å’Œè¯¾ç¨‹ä¸­æœ‰å“ªç§å¥½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¯¾ç¨‹ä¸­çš„å¥½ï¼Œå› ä¸ºå¦‚æœä½ é‡‡ç”¨æˆ‘åˆšè¯´çš„æ–¹å¼ï¼Œå¦‚æœè®¿é—®çš„äººå¾ˆå¤šï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯èƒ½ä¸€ä¸‹å­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œè€Œä¸”ä½ ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºï¼Œä½ è§‰å¾—æ—¶æ•ˆæ€§ä¼šéå¸¸é‡è¦ï¼Œä½†æ˜¯ä½ æƒ³æƒ³æ˜¯å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œæ¯”å¦‚æˆ‘åªè¦ç¡®å®šä»–èƒ½åšè¿™ä»¶äº‹ï¼Œç„¶åæˆ‘åè¾¹æ…¢æ…¢åšå°±å¯ä»¥äº†ï¼Œæˆ‘å¹¶ä¸éœ€è¦ä»–ä¸€å£æ°”åšå®Œè¿™ä»¶äº‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“é‡‡ç”¨çš„æ˜¯è¯¾ç¨‹ä¸­ï¼Œç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…æ˜¯å¼‚æ­¥ç¼–æ’çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653560986599.png" alt="1653560986599"></p>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼šæˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹</p>
<p>ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</p>
<p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomctä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653561657295.png" alt="1653561657295"></p>
<p>æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œ</p>
<p>å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653562234886.png" alt="1653562234886"></p>
<h3 id="6-2-ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­">6.2 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h3>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>
<p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
</li>
<li>
<p>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</p>
</li>
<li>
<p>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p>
</li>
<li>
<p>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1656080546603.png" alt="1656080546603"></p>
</li>
</ul>
<p>VoucherServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    <span class="comment">//SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­</span></span><br><span class="line">    <span class="comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´luaè¡¨è¾¾å¼</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId åˆ›å»ºseckill:order:</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>å½“ä»¥ä¸Šluaè¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•åï¼Œå‰©ä¸‹çš„å°±æ˜¯æ ¹æ®æ­¥éª¤3,4æ¥æ‰§è¡Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡äº†</p>
<p>VoucherOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// 3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–">6.3 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h3>
<p>VoucherOrderServiceImpl</p>
<p>ä¿®æ”¹ä¸‹å•åŠ¨ä½œï¼Œç°åœ¨æˆ‘ä»¬å»ä¸‹å•æ—¶ï¼Œæ˜¯é€šè¿‡luaè¡¨è¾¾å¼å»åŸå­æ‰§è¡Œåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœåˆ¤æ–­æˆ‘å‡ºæ¥ä¸ä¸º0 ï¼Œåˆ™è¦ä¹ˆæ˜¯åº“å­˜ä¸è¶³ï¼Œè¦ä¹ˆæ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™æŠŠä¸‹å•çš„é€»è¾‘ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä¹‹åï¼Œéšæ—¶éƒ½æ˜¯æœ‰å¯èƒ½è¦æ‰§è¡Œçš„</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">   SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨äºçº¿ç¨‹æ± å¤„ç†çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// å½“åˆå§‹åŒ–å®Œæ¯•åï¼Œå°±ä¼šå»ä»å¯¹åˆ—ä¸­å»æ‹¿ä¿¡æ¯</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">// 2.åˆ›å»ºè®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">          	 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">            <span class="comment">//1.è·å–ç”¨æˆ·</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">            <span class="comment">// 2.åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">            <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">            <span class="comment">// 3.å°è¯•è·å–é”</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.lock();</span><br><span class="line">            <span class="comment">// 4.åˆ¤æ–­æ˜¯å¦è·å¾—é”æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">                <span class="comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span><br><span class="line">                log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">//æ³¨æ„ï¼šç”±äºæ˜¯springçš„äº‹åŠ¡æ˜¯æ”¾åœ¨threadLocalä¸­ï¼Œæ­¤æ—¶çš„æ˜¯å¤šçº¿ç¨‹ï¼Œäº‹åŠ¡ä¼šå¤±æ•ˆ</span></span><br><span class="line">                proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                redisLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks =<span class="keyword">new</span>  <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">                SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(),</span><br><span class="line">                voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">        );</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 2.4.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 2.5.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        <span class="comment">// 2.6.æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line">        <span class="comment">//3.è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">         proxy = (IVoucherOrderService)AopContext.currentProxy();</span><br><span class="line">        <span class="comment">//4.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">      <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">           log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>å°æ€»ç»“ï¼š</strong></p>
<p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
<li>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ
<ul>
<li>å†…å­˜é™åˆ¶é—®é¢˜</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜</li>
</ul>
</li>
</ul>
<h2 id="7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—"><strong>7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—</strong></h2>
<h3 id="7-1-Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—">7.1 Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ul>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653574849336.png" alt="1653574849336"></p>
<p>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº **è§£è€¦ï¼š**æ‰€è°“è§£è€¦ï¼Œä¸¾ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­å°±æ˜¯ï¼šå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°å¿«é€’æŸœé‡Œè¾¹(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœé‡Œè¾¹å»æ‹¿ä¸œè¥¿ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆè¿™ä¸ªå¿«é€’å‘˜ç›¸å½“äºç›´æ¥æŠŠå¿«é€’äº¤ç»™ä½ ï¼Œè¿™äº‹å›ºç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€ä½ ä¸åœ¨å®¶ï¼Œé‚£ä¹ˆå¿«é€’å‘˜å°±ä¼šä¸€ç›´ç­‰ä½ ï¼Œè¿™å°±æµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™ç§æ€æƒ³åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬ç§’æ€ä¸­å°±å˜æˆäº†ï¼šæˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨rediså»è¿›è¡Œæ ¡éªŒä¸‹å•æ¡ä»¶ï¼Œå†é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åå†å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ¶ˆè´¹è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›ç°æˆçš„mqï¼Œæ¯”å¦‚kafkaï¼Œrabbitmqç­‰ç­‰ï¼Œä½†æ˜¯å‘¢ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…mqï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨redisæä¾›çš„mqæ–¹æ¡ˆï¼Œé™ä½æˆ‘ä»¬çš„éƒ¨ç½²å’Œå­¦ä¹ æˆæœ¬ã€‚</p>
<h3 id="7-2-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">7.2 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p><strong>åŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p>
<p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚<br>
ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653575176451.png" alt="1653575176451"></p>
<p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>
ä¼˜ç‚¹ï¼š</p>
<ul>
<li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li>
<li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li>
</ul>
<h3 id="7-3-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—">7.3 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p>
<p>SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“<br>
PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯<br>
PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653575506373.png" alt="1653575506373"></p>
<p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>
ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li>
</ul>
<h3 id="7-4-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—">7.4 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p>å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577301737.png" alt="1653577301737"></p>
<p>ä¾‹å¦‚ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577349691.png" alt="1653577349691"></p>
<p>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREAD</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577445413.png" alt="1653577445413"></p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577643629.png" alt="1653577643629"></p>
<p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577659166.png" alt="1653577659166"></p>
<p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577689129.png" alt="1653577689129"></p>
<p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜</p>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
</ul>
<h3 id="7-5-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„">7.5 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</h3>
<p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577801668.png" alt="1653577801668"></p>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š<br>
<img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653577984924.png" alt="1653577984924"><br>
keyï¼šé˜Ÿåˆ—åç§°<br>
groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°<br>
IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯<br>
MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—<br>
å…¶å®ƒå¸¸è§å‘½ä»¤ï¼š</p>
<p><strong>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP DESTORY key groupName</span><br></pre></td></tr></table></figure>
<p><strong>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATECONSUMER key groupname consumername</span><br></pre></td></tr></table></figure>
<p><strong>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP DELCONSUMER key groupname consumername</span><br></pre></td></tr></table></figure>
<p>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>
<ul>
<li>groupï¼šæ¶ˆè´¹ç»„åç§°</li>
<li>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
<li>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
<li>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li>
<li>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li>
<li>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</li>
<li>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹IDï¼š</li>
</ul>
<p>â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹<br>
å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</p>
<p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653578211854.png" alt="1653578211854">STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ul>
<p>æœ€åæˆ‘ä»¬æ¥ä¸ªå°å¯¹æ¯”</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653578560691.png" alt="1653578560691"></p>
<h3 id="7-6-åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•">7.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</h3>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•\</li>
</ul>
<p>ä¿®æ”¹luaè¡¨è¾¾å¼,æ–°å¢3.6</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1656082824939.png" alt="1656082824939"></p>
<p>VoucherOrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                    StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="8ã€è¾¾äººæ¢åº—">8ã€è¾¾äººæ¢åº—</h2>
<h3 id="8-1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°">8.1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°</h3>
<p>å‘å¸ƒæ¢åº—ç¬”è®°</p>
<p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š<br>
tb_blogï¼šæ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰<br>
tb_blog_commentsï¼šå…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</p>
<p><strong>å…·ä½“å‘å¸ƒæµç¨‹</strong></p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653578992639.png" alt="1653578992639"></p>
<p>ä¸Šä¼ æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">            <span class="comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">            <span class="comment">// ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">            image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šåŒå­¦ä»¬åœ¨æ“ä½œæ—¶ï¼Œéœ€è¦ä¿®æ”¹SystemConstants.IMAGE_UPLOAD_DIR è‡ªå·±å›¾ç‰‡æ‰€åœ¨çš„åœ°å€ï¼Œåœ¨å®é™…å¼€å‘ä¸­å›¾ç‰‡ä¸€èˆ¬ä¼šæ”¾åœ¨nginxä¸Šæˆ–è€…æ˜¯äº‘å­˜å‚¨ä¸Šã€‚</p>
<p>BlogController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUpdateTime(user.getId());</span><br><span class="line">        <span class="comment">//ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">        blogService.saveBlog(blog);</span><br><span class="line">        <span class="comment">//è¿”å›id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-2-è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°">8.2 è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°</h3>
<p>å®ç°æŸ¥çœ‹å‘å¸ƒæ¢åº—ç¬”è®°çš„æ¥å£</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653579931626.png" alt="1653579931626"></p>
<p>å®ç°ä»£ç ï¼š</p>
<p>BlogServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç¬”è®°ä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-3-è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½">8.3 è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½</h3>
<p>åˆå§‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked +1 &quot;</span>).eq(<span class="string">&quot;id&quot;</span>,id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜åˆ†æï¼šè¿™ç§æ–¹å¼ä¼šå¯¼è‡´ä¸€ä¸ªç”¨æˆ·æ— é™ç‚¹èµï¼Œæ˜æ˜¾æ˜¯ä¸åˆç†çš„</p>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨çš„é€»è¾‘ï¼Œå‘èµ·è¯·æ±‚åªæ˜¯ç»™æ•°æ®åº“+1ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653581590453.png" alt="1653581590453"></p>
<p>å®Œå–„ç‚¹èµåŠŸèƒ½</p>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li>
</ul>
<p>å®ç°æ­¥éª¤ï¼š</p>
<ul>
<li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li>
<li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1</li>
<li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
<li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
</ul>
<p>ä¸ºä»€ä¹ˆé‡‡ç”¨seté›†åˆï¼š</p>
<p>å› ä¸ºæˆ‘ä»¬çš„æ•°æ®æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œå½“ç”¨æˆ·æ“ä½œè¿‡ä¹‹åï¼Œæ— è®ºä»–æ€ä¹ˆæ“ä½œï¼Œéƒ½æ˜¯</p>
<p>å…·ä½“æ­¥éª¤ï¼š</p>
<p>1ã€åœ¨Blog æ·»åŠ ä¸€ä¸ªå­—æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Boolean isLike;</span><br></pre></td></tr></table></figure>
<p>2ã€ä¿®æ”¹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">       <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">       <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">       <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">       <span class="keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">            <span class="comment">//3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">           <span class="comment">//3.1 æ•°æ®åº“ç‚¹èµæ•°+1</span></span><br><span class="line">           <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">           <span class="comment">//3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ</span></span><br><span class="line">           <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">               stringRedisTemplate.opsForSet().add(key,userId.toString());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">           <span class="comment">//4.1 æ•°æ®åº“ç‚¹èµæ•°-1</span></span><br><span class="line">           <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">           <span class="comment">//4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">           <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">               stringRedisTemplate.opsForSet().remove(key,userId.toString());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-4-è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ">8.4 è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ</h3>
<p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œï¼š</p>
<p>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°seté›†åˆï¼Œä½†æ˜¯seté›†åˆæ˜¯ä¸èƒ½æ’åºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¯ä»¥æ’åºçš„seté›†åˆï¼Œå°±æ˜¯å’±ä»¬çš„sortedSet</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653805077118.png" alt="1653805077118"></p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥å¯¹æ¯”ä¸€ä¸‹è¿™äº›é›†åˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</p>
<p>æ‰€æœ‰ç‚¹èµçš„äººï¼Œéœ€è¦æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“ä½¿ç”¨setæˆ–è€…æ˜¯sortedSet</p>
<p>å…¶æ¬¡æˆ‘ä»¬éœ€è¦æ’åºï¼Œå°±å¯ä»¥ç›´æ¥é”å®šä½¿ç”¨sortedSetå•¦</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653805203758.png" alt="1653805203758"></p>
<p>ä¿®æ”¹ä»£ç </p>
<p>BlogServiceImpl</p>
<p>ç‚¹èµé€»è¾‘ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ  zadd key value score</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">         <span class="comment">// 4.1.æ•°æ®åº“ç‚¹èµæ•° -1</span></span><br><span class="line">         <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">         <span class="comment">// 4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">         <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">             stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> Result.ok();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isBlogLiked</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">     <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">     <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">     <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// ç”¨æˆ·æœªç™»å½•ï¼Œæ— éœ€æŸ¥è¯¢æ˜¯å¦ç‚¹èµ</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">     <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + blog.getId();</span><br><span class="line">     <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">     blog.setIsLike(score != <span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨</p>
<p>BlogController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogLikes(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BlogService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9ã€å¥½å‹å…³æ³¨">9ã€å¥½å‹å…³æ³¨</h2>
<h3 id="9-1-å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">9.1 å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3>
<p>é’ˆå¯¹ç”¨æˆ·çš„æ“ä½œï¼šå¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œå…³æ³¨å’Œå–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653806140822.png" alt="1653806140822"></p>
<p>å®ç°æ€è·¯ï¼š</p>
<p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li>å…³æ³¨å’Œå–å…³æ¥å£</li>
<li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li>
</ul>
<p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤ºï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653806253817.png" alt="1653806253817"></p>
<p>æ³¨æ„: è¿™é‡Œéœ€è¦æŠŠä¸»é”®ä¿®æ”¹ä¸ºè‡ªå¢é•¿ï¼Œç®€åŒ–å¼€å‘ã€‚</p>
<p>FollowController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> followService.follow(followUserId, isFollow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FollowService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">å–æ¶ˆå…³æ³¨service</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">// 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> å…³æ³¨service</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">        <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">            <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">            <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">            remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                    .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-2-å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨">9.2 å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨</h3>
<p>æƒ³è¦å»çœ‹å…±åŒå…³æ³¨çš„å¥½å‹ï¼Œéœ€è¦é¦–å…ˆè¿›å…¥åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ä¼šå‘èµ·ä¸¤ä¸ªè¯·æ±‚</p>
<p>1ã€å»æŸ¥è¯¢ç”¨æˆ·çš„è¯¦æƒ…</p>
<p>2ã€å»æŸ¥è¯¢ç”¨æˆ·çš„ç¬”è®°</p>
<p>ä»¥ä¸Šä¸¤ä¸ªåŠŸèƒ½å’Œå…±åŒå…³æ³¨æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå°†ç¬”è®°ä¸­çš„ä»£ç æ‹·è´åˆ°ideaä¸­å°±å¯ä»¥å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½äº†ï¼Œæˆ‘ä»¬çš„é‡ç‚¹åœ¨äºå…±åŒå…³æ³¨åŠŸèƒ½ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653806706296.png" alt="1653806706296"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long userId)</span>&#123;</span><br><span class="line">	<span class="comment">// æŸ¥è¯¢è¯¦æƒ…</span></span><br><span class="line">	<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">	<span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.ok();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">	<span class="comment">// è¿”å›</span></span><br><span class="line">	<span class="keyword">return</span> Result.ok(userDTO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BlogController  æ ¹æ®idæŸ¥è¯¢åšä¸»çš„æ¢åº—ç¬”è®°</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogByUserId</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">		<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">	<span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">	Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">			.eq(<span class="string">&quot;user_id&quot;</span>, id).page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">	<span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">	List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">	<span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å…±åŒå…³æ³¨å¦‚ä½•å®ç°ï¼š</p>
<p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨å‘¢ã€‚</p>
<p>å½“ç„¶æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡çš„seté›†åˆå’¯ï¼Œåœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„apiï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤äººçš„å…³æ³¨çš„äººåˆ†åˆ«æ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ï¼Œç„¶åå†é€šè¿‡apiå»æŸ¥çœ‹è¿™ä¸¤ä¸ªseté›†åˆä¸­çš„äº¤é›†æ•°æ®ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653806973212.png" alt="1653806973212"></p>
<p>æˆ‘ä»¬å…ˆæ¥æ”¹é€ å½“å‰çš„å…³æ³¨åˆ—è¡¨</p>
<p>æ”¹é€ åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·å…³æ³¨äº†æŸä½ç”¨æˆ·åï¼Œéœ€è¦å°†æ•°æ®æ”¾å…¥åˆ°seté›†åˆä¸­ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œå…±åŒå…³æ³¨ï¼ŒåŒæ—¶å½“å–æ¶ˆå…³æ³¨æ—¶ï¼Œä¹Ÿéœ€è¦ä»seté›†åˆä¸­è¿›è¡Œåˆ é™¤</p>
<p>FollowServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ sadd userId followerUserId</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…·ä½“çš„å…³æ³¨ä»£ç ï¼š</strong></p>
<p>FollowServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 2.æ±‚äº¤é›†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ— äº¤é›†</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è§£æidé›†åˆ</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-3-å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ">9.3 å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ</h3>
<p>å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·åï¼Œè¿™ä¸ªç”¨æˆ·å‘äº†åŠ¨æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®æˆ‘ä»¬åˆæŠŠä»–å«åšFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p>
<p>å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼çš„å†…å®¹è§£é”ï¼šæˆ‘ä»¬æ˜¯éœ€è¦ç”¨æˆ·å»é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–çš„æ–¹å¼å»è§£é”æƒ³è¦çœ‹çš„å†…å®¹</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653808641260.png" alt="1653808641260"></p>
<p>å¯¹äºæ–°å‹çš„Feedæµçš„çš„æ•ˆæœï¼šä¸éœ€è¦æˆ‘ä»¬ç”¨æˆ·å†å»æ¨é€ä¿¡æ¯ï¼Œè€Œæ˜¯ç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ çš„èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨ä¸»åŠ¨å»å¯»æ‰¾ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653808993693.png" alt="1653808993693"></p>
<p>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š<br>
Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
<p>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨<br>
æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</li>
</ul>
<p>æˆ‘ä»¬æœ¬æ¬¡é’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„å°±æ˜¯Timelineçš„æ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p>
<p>ï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ul>
<p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p>
<p>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰å°±æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››å’Œç‹äº”å‘äº†æ¶ˆæ¯åï¼Œéƒ½ä¼šä¿å­˜åœ¨è‡ªå·±çš„é‚®ç®±ä¸­ï¼Œå‡è®¾èµµå…­è¦è¯»å–ä¿¡æ¯ï¼Œé‚£ä¹ˆä»–ä¼šä»è¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼ŒæŠŠä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶ååœ¨è¿›è¡Œæ’åº</p>
<p>ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œè€Œä¸”è¯»å–å®Œä¹‹åå¯ä»¥æŠŠä»–çš„æ”¶ä»¶ç®±è¿›è¡Œæ¸…æ¥šã€‚</p>
<p>ç¼ºç‚¹ï¼šæ¯”è¾ƒå»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶æ‰å»å…³æ³¨çš„äººé‡Œè¾¹å»è¯»å–æ•°æ®ï¼Œå‡è®¾ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–æµ·é‡çš„å†…å®¹ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653809450816.png" alt="1653809450816"></p>
<p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p>
<p>æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨çš„æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­å»ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†</p>
<p>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</p>
<p>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šåˆ†æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653809875208.png" alt="1653809875208"></p>
<p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p>
<p>æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€æ®µï¼Œå¦‚æœæ˜¯ä¸ªæ™®é€šçš„äººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸ä¸­å»ï¼Œå› ä¸ºæ™®é€šçš„äººä»–çš„ç²‰ä¸å…³æ³¨é‡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™æ ·åšæ²¡æœ‰å‹åŠ›ï¼Œå¦‚æœæ˜¯å¤§Vï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å…ˆå†™å…¥åˆ°ä¸€ä»½åˆ°å‘ä»¶ç®±é‡Œè¾¹å»ï¼Œç„¶åå†ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸æ”¶ä»¶ç®±é‡Œè¾¹å»ï¼Œç°åœ¨ç«™åœ¨æ”¶ä»¶äººè¿™ç«¯æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§Vå’Œæ™®é€šçš„äººå‘çš„éƒ½ä¼šç›´æ¥å†™å…¥åˆ°è‡ªå·±æ”¶ä»¶ç®±é‡Œè¾¹æ¥ï¼Œè€Œå¦‚æœæ˜¯æ™®é€šçš„ç²‰ä¸ï¼Œç”±äºä»–ä»¬ä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿æ—¶ï¼Œå†ä»å‘ä»¶ç®±é‡Œè¾¹å»æ‹‰ä¿¡æ¯ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653812346852.png" alt="1653812346852"></p>
<h3 id="9-4-å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±">9.4 å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</h3>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</li>
<li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li>
<li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li>
</ul>
<p>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p>
<p>ä¼ ç»Ÿäº†åˆ†é¡µåœ¨feedæµæ˜¯ä¸é€‚ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–</p>
<p>å‡è®¾åœ¨t1 æ—¶åˆ»ï¼Œæˆ‘ä»¬å»è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page = 1 ï¼Œsize = 5 ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯10~6 è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾ç°åœ¨t2æ—¶å€™åˆå‘å¸ƒäº†ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶t3 æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œè¯»å–ç¬¬äºŒé¡µä¼ å…¥çš„å‚æ•°æ˜¯page=2 ï¼Œsize=5 ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–åˆ°çš„ç¬¬äºŒé¡µå®é™…ä¸Šæ˜¯ä»6 å¼€å§‹ï¼Œç„¶åæ˜¯6~2 ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»å–åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥feedæµçš„åˆ†é¡µï¼Œä¸èƒ½é‡‡ç”¨åŸå§‹æ–¹æ¡ˆæ¥åšã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653813047671.png" alt="1653813047671"></p>
<p>Feedæµçš„æ»šåŠ¨åˆ†é¡µ</p>
<p>æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹å»è¯»å–æ•°æ®</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†10~6ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡æ‹¿å–çš„è®°å½•ï¼Œå°±æ˜¯6ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çš„è®°å½•ï¼Œæ­¤æ—¶è¿™ä¸ª11æ”¾åˆ°æœ€é¡¶ä¸Šï¼Œä½†æ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰è®°å½•çš„6ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥æ‹¿ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¿™ä¸ªæ—¶å€™æ‹¿æ•°æ®ï¼Œè¿˜æ˜¯ä»6åä¸€ç‚¹çš„5å»æ‹¿ï¼Œå°±æ‹¿åˆ°äº†5-1çš„è®°å½•ã€‚æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹å¯ä»¥é‡‡ç”¨sortedSetæ¥åšï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®°å½•å½“å‰è·å–æ•°æ®æ—¶é—´æˆ³æœ€å°å€¼ï¼Œå°±å¯ä»¥å®ç°æ»šåŠ¨åˆ†é¡µäº†</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653813462834.png" alt="1653813462834"></p>
<p>æ ¸å¿ƒçš„æ„æ€ï¼šå°±æ˜¯æˆ‘ä»¬åœ¨ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å¾—åˆ°å½“å‰ç¬”è®°çš„ç²‰ä¸ï¼Œç„¶åæŠŠæ•°æ®æ¨é€åˆ°ç²‰ä¸çš„redisä¸­å»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// 4.2.æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±">9.5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±</h3>
<p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p>
<p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>
<p>1ã€æ¯æ¬¡æŸ¥è¯¢å®Œæˆåï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºæ•°æ®çš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶</p>
<p>2ã€æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®</p>
<p>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼šä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ å’Œåç§»é‡è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p>
<p>è¿™ä¸¤ä¸ªå‚æ•°ç¬¬ä¸€æ¬¡ä¼šç”±å‰ç«¯æ¥æŒ‡å®šï¼Œä»¥åçš„æŸ¥è¯¢å°±æ ¹æ®åå°ç»“æœä½œä¸ºæ¡ä»¶ï¼Œå†æ¬¡ä¼ é€’åˆ°åå°ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653819821591.png" alt="1653819821591"></p>
<p>ä¸€ã€å®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BlogController</p>
<p>æ³¨æ„ï¼šRequestParam è¡¨ç¤ºæ¥å—urlåœ°å€æ ä¼ å‚çš„æ³¨è§£ï¼Œå½“æ–¹æ³•ä¸Šå‚æ•°çš„åç§°å’Œurlåœ°å€æ ä¸ç›¸åŒæ—¶ï¼Œå¯ä»¥é€šè¿‡RequestParam æ¥è¿›è¡ŒæŒ‡å®š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BlogServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">        .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 3.éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class="comment">// 5 4 4 2 2</span></span><br><span class="line">        <span class="comment">// 4.1.è·å–id</span></span><br><span class="line">        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class="line">        <span class="comment">// 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span>(time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	os = minTime == max ? os : os + offset;</span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">// 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.å°è£…å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10ã€é™„è¿‘å•†æˆ·">10ã€é™„è¿‘å•†æˆ·</h2>
<h3 id="10-1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•">10.1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h3>
<p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li>
<li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li>
<li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li>
<li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li>
<li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li>
<li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li>
<li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li>
</ul>
<h3 id="10-2ã€-é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">10.2ã€ é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3>
<p>å…·ä½“åœºæ™¯è¯´æ˜ï¼š</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653822036941.png" alt="1653822036941"></p>
<p>å½“æˆ‘ä»¬ç‚¹å‡»ç¾é£Ÿä¹‹åï¼Œä¼šå‡ºç°ä¸€ç³»åˆ—çš„å•†å®¶ï¼Œå•†å®¶ä¸­å¯ä»¥æŒ‰ç…§å¤šç§æ’åºæ–¹å¼ï¼Œæˆ‘ä»¬æ­¤æ—¶å…³æ³¨çš„æ˜¯è·ç¦»ï¼Œè¿™ä¸ªåœ°æ–¹å°±éœ€è¦ä½¿ç”¨åˆ°æˆ‘ä»¬çš„GEOï¼Œå‘åå°ä¼ å…¥å½“å‰appæ”¶é›†çš„åœ°å€(æˆ‘ä»¬æ­¤å¤„æ˜¯å†™æ­»çš„) ï¼Œä»¥å½“å‰åæ ‡ä½œä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶ä¼ å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®å†è¿”å›ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653822021827.png" alt="1653822021827"></p>
<p>æˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°redisä¸­å»ï¼Œredisä¸­çš„GEOï¼ŒGEOåœ¨redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬æŠŠxå’Œyè½´ä¼ å…¥åˆ°redisåšçš„ç»çº¬åº¦ä½ç½®å»ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°menberä¸­å»ï¼Œæ¯•ç«Ÿä½œä¸ºredisæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼Œredisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å­˜å‚¨ä»–çš„idå³å¯ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥typeIdä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</p>
<p>ä»£ç </p>
<p>HmDianPingApplicationTests</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            <span class="comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-3-é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">10.3 é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3>
<p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„POM</p>
<p>ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;io.lettuce&lt;/groupId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.lettuce&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">6.1</span><span class="number">.6</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒæ­¥ï¼š</p>
<p>ShopController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ShopServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                    .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                    .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span></span><br><span class="line">                .search(</span><br><span class="line">                        key,</span><br><span class="line">                        GeoReference.fromCoordinate(x, y),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),</span><br><span class="line">                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 4.è§£æå‡ºid</span></span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">        <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">        List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 4.2.è·å–åº—é“ºid</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="comment">// 4.3.è·å–è·ç¦»</span></span><br><span class="line">            <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">            distanceMap.put(shopIdStr, distance);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="11ã€ç”¨æˆ·ç­¾åˆ°">11ã€ç”¨æˆ·ç­¾åˆ°</h2>
<h4 id="11-1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º">11.1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º</h4>
<p>æˆ‘ä»¬é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡mysqlæ¥å®Œæˆï¼Œæ¯”å¦‚è¯´ä»¥ä¸‹è¿™å¼ è¡¨</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653823145495.png" alt="1653823145495"></p>
<p>ç”¨æˆ·ä¸€æ¬¡ç­¾åˆ°ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººæ¯å¹´ç­¾åˆ°æ¬¡æ•°ä¸º10æ¬¡ï¼Œåˆ™è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡ä¸º 1äº¿æ¡</p>
<p>æ¯ç­¾åˆ°ä¸€æ¬¡éœ€è¦ä½¿ç”¨ï¼ˆ8 + 8 + 1 + 1 + 3 + 1ï¼‰å…±22 å­—èŠ‚çš„å†…å­˜ï¼Œä¸€ä¸ªæœˆåˆ™æœ€å¤šéœ€è¦600å¤šå­—èŠ‚</p>
<p>æˆ‘ä»¬å¦‚ä½•èƒ½å¤Ÿç®€åŒ–ä¸€ç‚¹å‘¢ï¼Ÿå…¶å®å¯ä»¥è€ƒè™‘å°æ—¶å€™ä¸€ä¸ªæŒºå¸¸è§çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å°æ—¶å€™ï¼Œå’±ä»¬å‡†å¤‡ä¸€å¼ å°å°çš„å¡ç‰‡ï¼Œä½ åªè¦ç­¾åˆ°å°±æ‰“ä¸Šä¸€ä¸ªå‹¾ï¼Œæˆ‘æœ€ååˆ¤æ–­ä½ æ˜¯å¦ç­¾åˆ°ï¼Œå…¶å®åªéœ€è¦åˆ°å°å¡ç‰‡ä¸Šçœ‹ä¸€çœ‹å°±çŸ¥é“äº†</p>
<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼è¿™æ ·çš„æ–¹æ¡ˆæ¥å®ç°æˆ‘ä»¬çš„ç­¾åˆ°éœ€æ±‚ã€‚</p>
<p>æˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0.</p>
<p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p>
<p>Redisä¸­æ˜¯åˆ©ç”¨stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯ 2^32ä¸ªbitä½ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653824498278.png" alt="1653824498278"></p>
<p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li>GETBIT ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li>
<li>BITCOUNT ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li>BITFIELD ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li>
<li>BITFIELD_RO ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li>BITOP ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li>
<li>BITPOS ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
<h4 id="11-2-ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½">11.2 ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½</h4>
<p>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
<p>æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥æŠŠå¹´å’Œæœˆä½œä¸ºbitMapçš„keyï¼Œç„¶åä¿å­˜åˆ°ä¸€ä¸ªbitMapä¸­ï¼Œæ¯æ¬¡ç­¾åˆ°å°±åˆ°å¯¹åº”çš„ä½ä¸ŠæŠŠæ•°å­—ä»0å˜æˆ1ï¼Œåªè¦å¯¹åº”æ˜¯1ï¼Œå°±è¡¨æ˜è¯´æ˜è¿™ä¸€å¤©å·²ç»ç­¾åˆ°äº†ï¼Œåä¹‹åˆ™æ²¡æœ‰ç­¾åˆ°ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡æ¥å£æ–‡æ¡£å‘ç°ï¼Œæ­¤æ¥å£å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•çš„å‚æ•°ï¼Œæ²¡æœ‰å‚æ•°æ€ä¹ˆç¡®å®æ˜¯å“ªä¸€å¤©ç­¾åˆ°å‘¢ï¼Ÿè¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡åå°ä»£ç ç›´æ¥è·å–å³å¯ï¼Œç„¶ååˆ°å¯¹åº”çš„åœ°å€ä¸Šå»ä¿®æ”¹bitMapã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653833970361.png" alt="1653833970361"></p>
<p><strong>ä»£ç </strong></p>
<p>UserController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redis SETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11-3-ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡">11.3 ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡</h4>
<p>**é—®é¢˜1ï¼š**ä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ<br>
ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653834455899.png" alt="1653834455899"></p>
<p>Javaé€»è¾‘ä»£ç ï¼šè·å¾—å½“å‰è¿™ä¸ªæœˆçš„æœ€åä¸€æ¬¡ç­¾åˆ°æ•°æ®ï¼Œå®šä¹‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç„¶åä¸åœçš„å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°è·å¾—ç¬¬ä¸€ä¸ªé0çš„æ•°å­—å³å¯ï¼Œæ¯å¾—åˆ°ä¸€ä¸ªé0çš„æ•°å­—è®¡æ•°å™¨+1ï¼Œç›´åˆ°éå†å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œå°±å¯ä»¥è·å¾—å½“å‰æœˆçš„ç­¾åˆ°æ€»å¤©æ•°äº†</p>
<p>**é—®é¢˜2ï¼š**å¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ</p>
<p>BITFIELD key GET u[dayOfMonth] 0</p>
<p>å‡è®¾ä»Šå¤©æ˜¯10å·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å½“å‰æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œè·å¾—åˆ°å½“å‰è¿™ä¸€å¤©çš„ä½æ•°ï¼Œæ˜¯10å·ï¼Œé‚£ä¹ˆå°±æ˜¯10ä½ï¼Œå»æ‹¿è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™10å¤©é‡Œè¾¹ç­¾åˆ°äº†å¤šå°‘æ¬¡å‘¢ï¼Ÿç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1å³å¯ã€‚</p>
<p><strong>é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</strong></p>
<p>æ³¨æ„ï¼šbitMapè¿”å›çš„æ•°æ®æ˜¯10è¿›åˆ¶ï¼Œå“ªå‡å¦‚è¯´è¿”å›ä¸€ä¸ªæ•°å­—8ï¼Œé‚£ä¹ˆæˆ‘å“ªå„¿çŸ¥é“åˆ°åº•å“ªäº›æ˜¯0ï¼Œå“ªäº›æ˜¯1å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦è®©å¾—åˆ°çš„10è¿›åˆ¶æ•°å­—å’Œ1åšä¸è¿ç®—å°±å¯ä»¥äº†ï¼Œå› ä¸º1åªæœ‰é‡è§1 æ‰æ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0 ï¼Œæˆ‘ä»¬æŠŠç­¾åˆ°ç»“æœå’Œ1è¿›è¡Œä¸æ“ä½œï¼Œæ¯ä¸ä¸€æ¬¡ï¼Œå°±æŠŠç­¾åˆ°ç»“æœå‘å³ç§»åŠ¨ä¸€ä½ï¼Œä¾æ¬¡å†…æ¨ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæˆé€ä¸ªéå†çš„æ•ˆæœäº†ã€‚</p>
<p>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p>
<p>æœ‰ç”¨æˆ·æœ‰æ—¶é—´æˆ‘ä»¬å°±å¯ä»¥ç»„ç»‡å‡ºå¯¹åº”çš„keyï¼Œæ­¤æ—¶å°±èƒ½æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·æˆªæ­¢è¿™å¤©çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œå†æ ¹æ®è¿™å¥—ç®—æ³•ï¼Œå°±èƒ½ç»Ÿè®¡å‡ºæ¥ä»–è¿ç»­ç­¾åˆ°çš„æ¬¡æ•°äº†</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653835784444.png" alt="1653835784444"></p>
<p>ä»£ç </p>
<p><strong>UserController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.signCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key,</span><br><span class="line">            BitFieldSubCommands.create()</span><br><span class="line">                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="literal">null</span> || num == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å¾ªç¯éå†</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½  // åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11-4-é¢å¤–åŠ é¤-å…³äºä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ">11.4 é¢å¤–åŠ é¤-å…³äºä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ</h4>
<p>å›é¡¾<strong>ç¼“å­˜ç©¿é€</strong>ï¼š</p>
<p>å‘èµ·äº†ä¸€ä¸ªæ•°æ®åº“ä¸å­˜åœ¨çš„ï¼Œredisé‡Œè¾¹ä¹Ÿä¸å­˜åœ¨çš„æ•°æ®ï¼Œé€šå¸¸ä½ å¯ä»¥æŠŠä»–çœ‹æˆä¸€ä¸ªæ”»å‡»</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>
<p>åˆ¤æ–­id&lt;0</p>
</li>
<li>
<p>å¦‚æœæ•°æ®åº“æ˜¯ç©ºï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å¾€redisé‡Œè¾¹æŠŠè¿™ä¸ªç©ºæ•°æ®ç¼“å­˜èµ·æ¥</p>
</li>
</ul>
<p>ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼šé‡åˆ°çš„é—®é¢˜æ˜¯å¦‚æœç”¨æˆ·è®¿é—®çš„æ˜¯idä¸å­˜åœ¨çš„æ•°æ®ï¼Œåˆ™æ­¤æ—¶å°±æ— æ³•ç”Ÿæ•ˆ</p>
<p>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆï¼šé‡åˆ°çš„é—®é¢˜æ˜¯ï¼šå¦‚æœæ˜¯ä¸åŒçš„idé‚£å°±å¯ä»¥é˜²æ­¢ä¸‹æ¬¡è¿‡æ¥ç›´å‡»æ•°æ®</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥å°†æ•°æ®åº“çš„æ•°æ®ï¼Œæ‰€å¯¹åº”çš„idå†™å…¥åˆ°ä¸€ä¸ªlisté›†åˆä¸­ï¼Œå½“ç”¨æˆ·è¿‡æ¥è®¿é—®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥å»åˆ¤æ–­listä¸­æ˜¯å¦åŒ…å«å½“å‰çš„è¦æŸ¥è¯¢çš„æ•°æ®ï¼Œå¦‚æœè¯´ç”¨æˆ·è¦æŸ¥è¯¢çš„idæ•°æ®å¹¶ä¸åœ¨listé›†åˆä¸­ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœlistä¸­åŒ…å«å¯¹åº”æŸ¥è¯¢çš„idæ•°æ®ï¼Œåˆ™è¯´æ˜ä¸æ˜¯ä¸€æ¬¡ç¼“å­˜ç©¿é€æ•°æ®ï¼Œåˆ™ç›´æ¥æ”¾è¡Œã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653836416586.png" alt="1653836416586"></p>
<p>ç°åœ¨çš„é—®é¢˜æ˜¯è¿™ä¸ªä¸»é”®å…¶å®å¹¶æ²¡æœ‰é‚£ä¹ˆçŸ­ï¼Œè€Œæ˜¯å¾ˆé•¿çš„ä¸€ä¸ª ä¸»é”®</p>
<p>å“ªæ€•ä½ å•ç‹¬å»æå–è¿™ä¸ªä¸»é”®ï¼Œä½†æ˜¯åœ¨11å¹´å·¦å³ï¼Œæ·˜å®çš„å•†å“æ€»é‡å°±å·²ç»è¶…è¿‡10äº¿ä¸ª</p>
<p>æ‰€ä»¥å¦‚æœé‡‡ç”¨ä»¥ä¸Šæ–¹æ¡ˆï¼Œè¿™ä¸ªlistä¹Ÿä¼šå¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨bitmapæ¥å‡å°‘listçš„å­˜å‚¨ç©ºé—´</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠlistæ•°æ®æŠ½è±¡æˆä¸€ä¸ªéå¸¸å¤§çš„bitmapï¼Œæˆ‘ä»¬ä¸å†ä½¿ç”¨listï¼Œè€Œæ˜¯å°†dbä¸­çš„idæ•°æ®åˆ©ç”¨å“ˆå¸Œæ€æƒ³ï¼Œæ¯”å¦‚ï¼š</p>
<p>id % bitmap.size  = ç®—å‡ºå½“å‰è¿™ä¸ªidå¯¹åº”åº”è¯¥è½åœ¨bitmapçš„å“ªä¸ªç´¢å¼•ä¸Šï¼Œç„¶åå°†è¿™ä¸ªå€¼ä»0å˜æˆ1ï¼Œç„¶åå½“ç”¨æˆ·æ¥æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ­¤æ—¶å·²ç»æ²¡æœ‰äº†listï¼Œè®©ç”¨æˆ·ç”¨ä»–æŸ¥è¯¢çš„idå»ç”¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•ï¼Œ ç®—å‡ºæ¥å½“å‰è¿™ä¸ªidåº”å½“è½åœ¨bitmapçš„å“ªä¸€ä½ï¼Œç„¶ååˆ¤æ–­è¿™ä¸€ä½æ˜¯0ï¼Œè¿˜æ˜¯1ï¼Œå¦‚æœæ˜¯0åˆ™è¡¨æ˜è¿™ä¸€ä½ä¸Šçš„æ•°æ®ä¸€å®šä¸å­˜åœ¨ï¼Œ  é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†ï¼Œéœ€è¦é‡ç‚¹è€ƒè™‘ä¸€ä¸ªäº‹æƒ…ï¼Œå°±æ˜¯è¯¯å·®ç‡ï¼Œæ‰€è°“çš„è¯¯å·®ç‡å°±æ˜¯æŒ‡å½“å‘ç”Ÿå“ˆå¸Œå†²çªçš„æ—¶å€™ï¼Œäº§ç”Ÿçš„è¯¯å·®ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653836578970.png" alt="1653836578970"></p>
<p>12ã€UVç»Ÿè®¡</p>
<h3 id="12-1-ã€UVç»Ÿè®¡-HyperLogLog">12.1 ã€UVç»Ÿè®¡-HyperLogLog</h3>
<p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li>
<li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li>
</ul>
<p>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</p>
<p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<p>Hyperloglog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a><br>
Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜<strong>æ°¸è¿œå°äº16kb</strong>ï¼Œ<strong>å†…å­˜å ç”¨ä½</strong>çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<strong>æœ‰å°äº0.81ï¼…çš„è¯¯å·®</strong>ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653837988985.png" alt="1653837988985"></p>
<h3 id="12-2-UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡">12.2 UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</h3>
<p>æµ‹è¯•æ€è·¯ï¼šæˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•</p>
<p><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/1653838053608.png" alt="1653838053608"></p>
<p>ç»è¿‡æµ‹è¯•ï¼šæˆ‘ä»¬ä¼šå‘ç”Ÿä»–çš„è¯¯å·®æ˜¯åœ¨å…è®¸èŒƒå›´å†…ï¼Œå¹¶ä¸”å†…å­˜å ç”¨æå°</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://u7u7.top/posts/dp.html">https://u7u7.top/posts/dp.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>U7's BlogğŸ‹</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2025-07-28</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2025-08-03</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>SpringBoot</a><a class="post-meta__tags" href="/tags/Java/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Java</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>é¡¹ç›®</a><a class="post-meta__tags" href="/tags/Redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Redis</a><a class="post-meta__tags" href="/tags/Mybatis-plus/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Mybatis-plus</a><a class="post-meta__tags" href="/tags/Mybatis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Mybatis</a><a class="post-meta__tags" href="/tags/Mysql/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Mysql</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/wechat.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/alipay.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/ms.html"><img class="prev-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-5g7ew7.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">é¢è¯•é¢˜é›†</div></div></a></div><div class="next-post pull-right"><a href="/posts/suanfaProject.html"><img class="next-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-jx5xyw.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ç®—æ³•é¢˜</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/ms.html" title="é¢è¯•é¢˜é›†"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-5g7ew7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-08</div><div class="title">é¢è¯•é¢˜é›†</div></div></a></div><div><a href="/posts/ea7374cf.html" title="ç‘å‰å¤–å–ä¼˜åŒ–"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-6oe337.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-10</div><div class="title">ç‘å‰å¤–å–ä¼˜åŒ–</div></div></a></div><div><a href="/posts/a1e1aa91.html" title="ç‘å‰å¤–å–"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-28mkg9_2560x1440.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2023-03-11</div><div class="title">ç‘å‰å¤–å–</div></div></a></div><div><a href="/posts/22biji10.html" title="10æœˆç¬”è®°"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-1kmx19_2560x1440.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2022-10-11</div><div class="title">10æœˆç¬”è®°</div></div></a></div><div><a href="/posts/CloudAli.html" title="å¾®æœåŠ¡SpringCloudAlibaba"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/20250728154351340.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-25</div><div class="title">å¾®æœåŠ¡SpringCloudAlibaba</div></div></a></div><div><a href="/posts/leetcodeSF.html" title="åŠ›æ‰£åˆ·é¢˜"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/20250728154336465.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-20</div><div class="title">åŠ›æ‰£åˆ·é¢˜</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E6%8E%A2%E7%A4%BE%E4%BA%A4%E8%B4%AD%E4%BA%91%E5%B9%B3%E5%8F%B0"><span class="toc-text">ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E6%80%BB%E7%BB%93-%E9%87%8D%E7%82%B9"><span class="toc-text">ç§’æ€æ€»ç»“(é‡ç‚¹):</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BF%9D%E8%AF%81%E8%AE%A2%E5%8D%95ID%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80"><span class="toc-text">1ã€ä¿è¯è®¢å•IDå…¨å±€å”¯ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A7%A3%E5%86%B3%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-text">2ã€è§£å†³è¶…å–é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-text">2.1 ä½¿ç”¨æ•°æ®åº“ä¹è§‚é”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%A7%A3%E5%86%B3%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98"><span class="toc-text">3ã€è§£å†³ä¸€äººä¸€å•é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%88%9D%E5%A7%8B%E7%89%88%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%A4%E6%96%AD"><span class="toc-text">3.1 åˆå§‹ç‰ˆæ•°æ®åº“åˆ¤æ–­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%A7%A3%E5%86%B3%E9%94%81%E5%A4%B1%E6%95%88"><span class="toc-text">3.2 åˆ†å¸ƒå¼é”è§£å†³é”å¤±æ•ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-redisson%E8%A7%A3%E5%86%B3%E5%9B%9B%E5%A4%A7%E9%97%AE%E9%A2%98"><span class="toc-text">3.3 redissonè§£å†³å››å¤§é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80"><span class="toc-text">4ã€å¼‚æ­¥ç§’æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">5ã€æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81jmeter%E6%B5%8B%E8%AF%95%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%8C%E6%B7%BB%E5%8A%A0token"><span class="toc-text">6ã€jmeteræµ‹è¯•é«˜å¹¶å‘ï¼Œæ·»åŠ token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1ã€çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%AF%BC%E5%85%A5%E4%BC%98%E6%8E%A2%E7%A4%BE%E4%BA%A4%E8%B4%AD%E4%BA%91%E5%B9%B3%E5%8F%B0%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.1ã€å¯¼å…¥ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°é¡¹ç›®</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E3%80%81%E5%AF%BC%E5%85%A5SQL"><span class="toc-text">1.1.1 ã€å¯¼å…¥SQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2%E3%80%81%E6%9C%89%E5%85%B3%E5%BD%93%E5%89%8D%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.1.2ã€æœ‰å…³å½“å‰æ¨¡å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3%E3%80%81%E5%AF%BC%E5%85%A5%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.1.3ã€å¯¼å…¥åç«¯é¡¹ç›®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-4%E3%80%81%E5%AF%BC%E5%85%A5%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B"><span class="toc-text">1.1.4ã€å¯¼å…¥å‰ç«¯å·¥ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81redis%E8%AE%BE%E8%AE%A1"><span class="toc-text">1.2ã€redisè®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1%E3%80%81%E8%AE%BE%E8%AE%A1key%E7%9A%84%E5%85%B7%E4%BD%93%E7%BB%86%E8%8A%82"><span class="toc-text">1.2.1ã€è®¾è®¡keyçš„å…·ä½“ç»†èŠ‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2%E3%80%81%E6%95%B4%E4%BD%93%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2.2ã€æ•´ä½“è®¿é—®æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81%E4%BD%BF%E7%94%A8redis%E5%AE%8C%E6%88%90%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1.3ã€ä½¿ç”¨rediså®ŒæˆçŸ­ä¿¡ç™»å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-text">1.4 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-%E5%88%9D%E5%A7%8B%E6%96%B9%E6%A1%88%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">1.4.1 åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">1.4.2 ä¼˜åŒ–æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-%E4%BB%A3%E7%A0%81"><span class="toc-text">1.4.3 ä»£ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-text">2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%B7%BB%E5%8A%A0%E5%95%86%E6%88%B7%E7%BC%93%E5%AD%98"><span class="toc-text">2.1 æ·»åŠ å•†æˆ·ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E3%80%81%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%80%9D%E8%B7%AF"><span class="toc-text">2.1.1 ã€ç¼“å­˜æ¨¡å‹å’Œæ€è·¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2%E3%80%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-%E4%BD%BF%E7%94%A8SpringCache-%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99"><span class="toc-text">2.1.2ã€ä»£ç å®ç° ä½¿ç”¨SpringCache(ç¼“å­˜åŒå†™)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3%E3%80%81%E5%AE%9E%E7%8E%B0cacheable%E8%AE%BE%E7%BD%AEttl"><span class="toc-text">2.1.3ã€å®ç°cacheableè®¾ç½®ttl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="toc-text">2.2 è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E7%BC%96%E7%A0%81%E8%A7%A3%E5%86%B3%E5%95%86%E5%93%81%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-text">2.2.1 ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">2.3 ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">2.4 ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%88%A9%E7%94%A8%E4%BA%92%E6%96%A5%E9%94%81%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">2.5 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6%E3%80%81%E5%88%A9%E7%94%A8%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">2.6ã€åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7%E3%80%81%E5%B0%81%E8%A3%85Redis%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">2.7ã€å°è£…Rediså·¥å…·ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%BC%98%E6%83%A0%E5%8D%B7%E7%A7%92%E6%9D%80"><span class="toc-text">3ã€ä¼˜æƒ å·ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">3.1 -å…¨å±€å”¯ä¸€ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Redis%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80Id"><span class="toc-text">3.2 -Rediså®ç°å…¨å±€å”¯ä¸€Id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%B7%BB%E5%8A%A0%E4%BC%98%E6%83%A0%E5%8D%B7"><span class="toc-text">3.3 æ·»åŠ ä¼˜æƒ å·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">3.4 å®ç°ç§’æ€ä¸‹å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%B9%90%E8%A7%82%E9%94%81%E8%A7%A3%E5%86%B3%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-text">3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80-%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-text">3.6 ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-text">3.7 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4ã€åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E3%80%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-text">4.1 ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E3%80%81Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF"><span class="toc-text">4.2 ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%89%88%E6%9C%AC%E4%B8%80"><span class="toc-text">4.3 å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E6%83%85%E5%86%B5%E8%AF%B4%E6%98%8E"><span class="toc-text">4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E8%A7%A3%E5%86%B3Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E9%97%AE%E9%A2%98"><span class="toc-text">4.5 è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.6 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-Lua%E8%84%9A%E6%9C%AC%E8%A7%A3%E5%86%B3%E5%A4%9A%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.7 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E5%88%A9%E7%94%A8Java%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8Lua%E8%84%9A%E6%9C%AC%E6%94%B9%E9%80%A0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4.8 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission"><span class="toc-text">5ã€åˆ†å¸ƒå¼é”-redission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.1 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-Redission%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">5.2 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">5.3 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E9%94%81%E9%87%8D%E8%AF%95%E5%92%8CWatchDog%E6%9C%BA%E5%88%B6"><span class="toc-text">5.4 åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E9%94%81%E7%9A%84MutiLock%E5%8E%9F%E7%90%86"><span class="toc-text">5.5 åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6ã€ç§’æ€ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">6.1 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-Redis%E5%AE%8C%E6%88%90%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC%E5%88%A4%E6%96%AD"><span class="toc-text">6.2 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6.3 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E8%AE%A4%E8%AF%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.1 Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EList%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.2 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EPubSub%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.3 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.4 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-text">7.5 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E5%9F%BA%E4%BA%8ERedis%E7%9A%84Stream%E7%BB%93%E6%9E%84%E4%BD%9C%E4%B8%BA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">7.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-text">8ã€è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E3%80%81%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">8.1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">8.2 è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">8.3 è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">8.4 è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-text">9ã€å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">9.1 å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">9.2 å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">9.3 å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E6%8E%A8%E9%80%81%E5%88%B0%E7%B2%89%E4%B8%9D%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">9.4 å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E9%82%AE%E7%AE%B1"><span class="toc-text">9.5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7"><span class="toc-text">10ã€é™„è¿‘å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1%E3%80%81%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">10.1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2%E3%80%81-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">10.2ã€ é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">10.3 é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-text">11ã€ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA"><span class="toc-text">11.1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">11.2 ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">11.3 ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-%E9%A2%9D%E5%A4%96%E5%8A%A0%E9%A4%90-%E5%85%B3%E4%BA%8E%E4%BD%BF%E7%94%A8bitmap%E6%9D%A5%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%9A%84%E6%96%B9%E6%A1%88"><span class="toc-text">11.4 é¢å¤–åŠ é¤-å…³äºä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E3%80%81UV%E7%BB%9F%E8%AE%A1-HyperLogLog"><span class="toc-text">12.1 ã€UVç»Ÿè®¡-HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-UV%E7%BB%9F%E8%AE%A1-%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text">12.2 UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By U7's BlogğŸ‹</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20230913" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20230913å·"><img src="https://u7img.oss-cn-hangzhou.aliyuncs.com/202303221541743.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://u7-cc.u7u7.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://u7-cc.u7u7.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !flase) {
    if (flase) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/å­¦ä¹ ç¬”è®°/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ U7ã®å­¦ä¹ ç¬”è®° (16)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/æ‚é¡¹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ U7ã®Life&Workæ‚é¡¹ (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/é¡¹ç›®/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ U7ã®é¡¹ç›®ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/å·¥ä½œæœˆæ€»ç»“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ U7ã®å·¥ä½œæœˆæ€»ç»“ (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ U7ã®ç®—æ³•å­¦ä¹ ç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://u7u7.top/categories/é¢è¯•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ U7ã®é¢è¯• (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://u7u7.top/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/CloudAli.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blognoteImg/20250728154351340.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/CloudAli.html&quot;);" href="javascript:void(0);" alt="">å¾®æœåŠ¡SpringCloudAlibaba</a><div class="blog-slider__text">æ¢³ç†çš„å¾®æœåŠ¡é‡è¦çŸ¥è¯†ç‚¹ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/CloudAli.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ms.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-5g7ew7.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ms.html&quot;);" href="javascript:void(0);" alt="">é¢è¯•é¢˜é›†</a><div class="blog-slider__text">å¸¸è§é¢è¯•é¢˜æ¢³ç†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ms.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/dp.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-g7vgkd.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/dp.html&quot;);" href="javascript:void(0);" alt="">ä¼˜æ¢ç¤¾äº¤è´­äº‘å¹³å°</a><div class="blog-slider__text">å­¦ä¹ é¡¹ç›®ä»0-1</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/dp.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/a1e1aa91.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-28mkg9_2560x1440.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-03-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/a1e1aa91.html&quot;);" href="javascript:void(0);" alt="">ç‘å‰å¤–å–</a><div class="blog-slider__text">SpringBooté¡¹ç›®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/a1e1aa91.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/Cpp.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-nkro5m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-05-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/Cpp.html&quot;);" href="javascript:void(0);" alt="">C++å…¥é—¨</a><div class="blog-slider__text">c++å…¥é—¨ing</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/Cpp.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/dashuju2.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-572k81.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-04-27</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/dashuju2.html&quot;);" href="javascript:void(0);" alt="">24å¹´å¤§æ•°æ®åº”ç”¨çœèµ›æ€»ç»“</a><div class="blog-slider__text">ç¦»çº¿æ¨¡å—---çœèµ›è¸©å‘ç‚¹ï¼Œä»¥åŠéš¾ç‚¹ä½¿ç”¨</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/dashuju2.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>